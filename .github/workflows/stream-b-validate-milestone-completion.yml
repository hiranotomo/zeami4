# Event Model v1 - STREAM B: Meta-Operations
# Purpose: Validate milestone completion
# Triggers: milestone (closed)
# Dependencies: None
# Last updated: 2025-11-23

name: âš ï¸ ãƒžã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³å®Œäº†æ¤œè¨¼

on:
  milestone:
    types: [closed]

permissions:
  issues: write

jobs:
  validate-completion:
    name: Check All Issues Completed
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      issues: write

    steps:
      - name: Validate Milestone Completion
        uses: actions/github-script@v7
        with:
          script: |
            const milestone = context.payload.milestone;

            console.log(`Validating milestone: ${milestone.title} (ID: ${milestone.number})`);

            // Milestoneã«ç´ã¥ãå…¨ã¦ã®Issueã‚’å–å¾—
            const { data: allIssues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              milestone: milestone.number,
              state: 'all',
              per_page: 100
            });

            console.log(`Total issues in milestone: ${allIssues.length}`);

            // openãªIssueã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            const openIssues = allIssues.filter(issue =>
              issue.state === 'open' && !issue.pull_request
            );

            console.log(`Open issues found: ${openIssues.length}`);

            if (openIssues.length > 0) {
              // æœªå®Œäº†IssueãŒã‚ã‚‹å ´åˆ
              console.log('âš ï¸ Milestone has open issues. Reopening...');

              // Milestoneã‚’å†ã‚ªãƒ¼ãƒ—ãƒ³
              await github.rest.issues.updateMilestone({
                owner: context.repo.owner,
                repo: context.repo.repo,
                milestone_number: milestone.number,
                state: 'open'
              });

              console.log('âœ… Milestone reopened');

              // æœªå®Œäº†Issueã®ãƒªã‚¹ãƒˆã‚’ä½œæˆ
              const issueList = openIssues.map(issue =>
                `- #${issue.number}: ${issue.title}`
              ).join('\n');

              // è­¦å‘Šã‚³ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆ
              const warningMessage = [
                `## âš ï¸ Milestoneã€Œ${milestone.title}ã€ã«æœªå®Œäº†IssueãŒã‚ã‚Šã¾ã™`,
                '',
                'ã“ã®Milestoneã‚’ã‚¯ãƒ­ãƒ¼ã‚ºã—ã‚ˆã†ã¨ã—ã¾ã—ãŸãŒã€ä»¥ä¸‹ã®IssueãŒã¾ã å®Œäº†ã—ã¦ã„ã¾ã›ã‚“:',
                '',
                issueList,
                '',
                '### å¯¾å¿œæ–¹æ³•:',
                '1. ä¸Šè¨˜ã®å…¨ã¦ã®Issueã‚’å®Œäº†ï¼ˆã‚¯ãƒ­ãƒ¼ã‚ºï¼‰ã—ã¦ãã ã•ã„',
                '2. ã™ã¹ã¦ã®IssueãŒå®Œäº†ã—ãŸã‚‰ã€å†åº¦Milestoneã‚’ã‚¯ãƒ­ãƒ¼ã‚ºã§ãã¾ã™',
                '',
                '### ã¾ãŸã¯:',
                '- ã“ã‚Œã‚‰ã®Issueã‚’åˆ¥ã®Milestoneã«ç§»å‹•ã™ã‚‹',
                '- ã“ã‚Œã‚‰ã®Issueã‚’ã‚¯ãƒ­ãƒ¼ã‚ºã›ãšã«Milestoneã‹ã‚‰å‰Šé™¤ã™ã‚‹',
                '',
                `ðŸ“Š **é€²æ—**: ${allIssues.length - openIssues.length}/${allIssues.length} Issueså®Œäº†`,
                '',
                '---',
                '',
                'ðŸ’¡ **Note**: ã“ã®Milestoneã¯è‡ªå‹•çš„ã«å†ã‚ªãƒ¼ãƒ—ãƒ³ã•ã‚Œã¾ã—ãŸã€‚ã™ã¹ã¦ã®Issueã‚’å®Œäº†ã—ã¦ã‹ã‚‰å†åº¦ã‚¯ãƒ­ãƒ¼ã‚ºã—ã¦ãã ã•ã„ã€‚'
              ].join('\n');

              // Milestoneã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ï¼ˆæœ€æ–°ã®Issueã«ã‚³ãƒ¡ãƒ³ãƒˆï¼‰
              // Milestoneãƒ‡ã‚£ã‚¹ã‚«ãƒƒã‚·ãƒ§ãƒ³æ©Ÿèƒ½ãŒãªã„ãŸã‚ã€æœ€æ–°ã®é–¢é€£Issueã«ã‚³ãƒ¡ãƒ³ãƒˆ
              if (allIssues.length > 0) {
                // æœ€æ–°ã®Issueï¼ˆopenã¾ãŸã¯closedï¼‰ã«ã‚³ãƒ¡ãƒ³ãƒˆ
                const latestIssue = allIssues.sort((a, b) =>
                  new Date(b.updated_at) - new Date(a.updated_at)
                )[0];

                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: latestIssue.number,
                  body: warningMessage
                });

                console.log(`Warning comment added to Issue #${latestIssue.number}`);
              }

              // å„æœªå®Œäº†Issueã«ã‚‚å€‹åˆ¥ã«é€šçŸ¥
              for (const issue of openIssues) {
                const individualWarning = [
                  `âš ï¸ ã“ã®Issueã¯ã€Milestoneã€Œ**${milestone.title}**ã€ã®å®Œäº†ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ã¦ã„ã¾ã™ã€‚`,
                  '',
                  'ã“ã®Issueã‚’å®Œäº†ã™ã‚‹ã‹ã€åˆ¥ã®Milestoneã«ç§»å‹•ã—ã¦ãã ã•ã„ã€‚',
                  '',
                  `ðŸ“Š æ®‹ã‚Šã®æœªå®Œäº†Issue: ${openIssues.length}ä»¶`
                ].join('\n');

                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: individualWarning
                });

                console.log(`Individual warning added to Issue #${issue.number}`);
              }

              // ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å¤±æ•—ã•ã›ã‚‹
              core.setFailed(`âŒ Milestone cannot be closed: ${openIssues.length} open issue(s) remaining`);

            } else {
              // å…¨Issueå®Œäº†ã®å ´åˆ
              console.log('âœ… All issues in milestone are completed');

              const closedIssues = allIssues.filter(issue =>
                issue.state === 'closed' && !issue.pull_request
              );

              const completionMessage = [
                `## âœ… Milestoneã€Œ${milestone.title}ã€ãŒå®Œäº†ã—ã¾ã—ãŸï¼`,
                '',
                `ðŸŽ‰ ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼ã“ã®Milestoneã®å…¨ã¦ã®IssueãŒå®Œäº†ã—ã¾ã—ãŸã€‚`,
                '',
                `ðŸ“Š **å®Œäº†çµ±è¨ˆ**:`,
                `- å®Œäº†ã—ãŸIssue: ${closedIssues.length}ä»¶`,
                `- ç·Issueæ•°: ${allIssues.length}ä»¶`,
                '',
                '### æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:',
                '- æ¬¡ã®Milestoneã®è¨ˆç”»ã‚’ç«‹ã¦ã‚‹',
                '- å­¦ç¿’å†…å®¹ã‚’æŒ¯ã‚Šè¿”ã‚‹',
                '- ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°ã™ã‚‹',
                '',
                '---',
                '',
                'ðŸ’¡ **ç´ æ™´ã‚‰ã—ã„é€²æ—ã§ã™ï¼æ¬¡ã®ãƒ•ã‚§ãƒ¼ã‚ºã«é€²ã¿ã¾ã—ã‚‡ã†ã€‚**'
              ].join('\n');

              // å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æœ€æ–°ã®Issueã«æŠ•ç¨¿
              if (allIssues.length > 0) {
                const latestIssue = allIssues.sort((a, b) =>
                  new Date(b.updated_at) - new Date(a.updated_at)
                )[0];

                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: latestIssue.number,
                  body: completionMessage
                });

                console.log(`Completion message added to Issue #${latestIssue.number}`);
              }

              console.log(`âœ… Milestone "${milestone.title}" successfully closed with all issues completed`);
            }
