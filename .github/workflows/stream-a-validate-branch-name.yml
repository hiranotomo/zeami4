# Event Model v1 - STREAM A: PR-Lifecycle
# Purpose: Validate branch naming convention
# Triggers: pull_request
# Dependencies: None
# Last updated: 2025-11-23

name: Validate Branch Name

on:
  pull_request:
    types: [opened, edited, synchronize]

permissions:
  issues: write
  pull-requests: write

jobs:
  validate-branch-name:
    name: Check Branch Naming Convention
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Validate branch name format
        uses: actions/github-script@v7
        with:
          script: |
            // PRã®å ´åˆã¯head_refã€ç›´æ¥pushã®å ´åˆã¯ref_nameã‚’ä½¿ç”¨
            const branch = context.payload.pull_request
              ? context.payload.pull_request.head.ref
              : context.ref.replace('refs/heads/', '');

            console.log(`Checking branch name: ${branch}`);

            // è¨±å¯ã•ã‚Œã‚‹ãƒ–ãƒ©ãƒ³ãƒåã®ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆã‚·ãƒ³ãƒ—ãƒ«åŒ–ç‰ˆï¼‰
            // {type}/{issueç•ªå·}-{description}
            // type: feature, hotfix, docs, test, fix
            // description: ä»»æ„ã®èª¬æ˜ï¼ˆè‹±æ•°å­—ã€ãƒã‚¤ãƒ•ãƒ³ã€ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ï¼‰
            const validPattern = /^(feature|hotfix|docs|test|fix)\/\d+-[\w-]+$/;

            if (!validPattern.test(branch)) {
              const errorMessage = [
                '## âŒ ãƒ–ãƒ©ãƒ³ãƒåãŒå‘½åè¦å‰‡ã«å¾“ã£ã¦ã„ã¾ã›ã‚“',
                '',
                `ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒå: \`${branch}\``,
                '',
                '### æ­£ã—ã„å½¢å¼:',
                '```',
                '{type}/{Issueç•ªå·}-{description}',
                '',
                'type: feature, hotfix, docs, test, fix',
                'description: ä»»æ„ã®èª¬æ˜ï¼ˆè‹±æ•°å­—ã€ãƒã‚¤ãƒ•ãƒ³ã€ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ï¼‰',
                '```',
                '',
                '### ä¾‹:',
                '- `feature/183-add-auto-merge` âœ…',
                '- `hotfix/200-fix-validation` âœ…',
                '- `docs/194-update-readme` âœ…',
                '- `test/201-add-workflow-tests` âœ…',
                '- `fix/185-branch-naming` âœ…',
                '',
                '### ãªãœå¿…è¦ï¼Ÿ',
                '- Issue-PR-Closeã‚µã‚¤ã‚¯ãƒ«ã®å®Œå…¨æ€§ã‚’ä¿è¨¼',
                '- LLMãŒIssueç•ªå·ã‚’å¿˜ã‚Œã‚‹ã“ã¨ã‚’é˜²æ­¢',
                '- å¤‰æ›´ã®è¿½è·¡å¯èƒ½æ€§ã‚’ç¢ºä¿',
                '',
                '### ä¿®æ­£æ–¹æ³•:',
                '1. é–¢é€£ã™ã‚‹Issueã‚’ä½œæˆï¼ˆã¾ãŸã¯æ—¢å­˜Issueã‚’ç¢ºèªï¼‰',
                '2. æ­£ã—ã„å½¢å¼ã®ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆ:',
                '   ```bash',
                '   # ãƒ–ãƒ©ãƒ³ãƒä½œæˆ',
                '   git checkout -b feature/{Issueç•ªå·}-{description}',
                '   # ä¾‹: feature/183-add-auto-merge',
                '   ',
                '   git cherry-pick {ç¾åœ¨ã®ã‚³ãƒŸãƒƒãƒˆ}',
                '   ```',
                '',
                '### ã“ã®ãƒã‚§ãƒƒã‚¯ã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹å ´åˆ:',
                'ç‰¹åˆ¥ãªç†ç”±ãŒã‚ã‚‹å ´åˆã¯ã€PRã«ã€Œskip-branch-checkã€ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚'
              ].join('\n');

              // PRã®å ´åˆã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿
              if (context.payload.pull_request) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.payload.pull_request.number,
                  body: errorMessage
                });
              }

              core.setFailed(`::error title=ğŸ”´ å¯¾å¿œå¿…è¦: ãƒ–ãƒ©ãƒ³ãƒåæ¤œè¨¼å¤±æ•—::ãƒ–ãƒ©ãƒ³ãƒåãŒå‘½åè¦å‰‡ã«å¾“ã£ã¦ã„ã¾ã›ã‚“`);
              core.setFailed(`ãƒ–ãƒ©ãƒ³ãƒåãŒå‘½åè¦å‰‡ã«å¾“ã£ã¦ã„ã¾ã›ã‚“: ${branch}`);
            } else {
              console.log(`âœ… Branch name is valid: ${branch}`);
              console.log('::notice title=âœ… å¯¾å¿œä¸è¦: ãƒ–ãƒ©ãƒ³ãƒåæ¤œè¨¼æˆåŠŸ::ãƒ–ãƒ©ãƒ³ãƒåãŒæ­£ã—ã„å½¢å¼ã§ã™');

              // ãƒ–ãƒ©ãƒ³ãƒæƒ…å ±ã‚’æŠ½å‡º
              const match = branch.match(/\/(\d+)-([\w-]+)$/);
              const issueNumber = match[1];
              const description = match[2];
              console.log(`Branch validated - Issue: ${issueNumber}, Description: ${description}`);

              // PRã®å ´åˆã€æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æŠ•ç¨¿
              if (context.payload.pull_request) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.payload.pull_request.number,
                  body: `âœ… ãƒ–ãƒ©ãƒ³ãƒåãŒæ­£ã—ã„å½¢å¼ã§ã™\n\n` +
                    `- **Branch**: \`${branch}\`\n` +
                    `- **Issue**: #${issueNumber}\n` +
                    `- **Description**: ${description}`
                });
              }
            }
