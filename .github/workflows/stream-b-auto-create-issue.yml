# Event Model v1 - STREAM B: Meta-Operations
# Purpose: Auto-create issue for branches
# Triggers: workflow_dispatch
# Dependencies: None
# Last updated: 2025-11-23

name: â„¹ï¸ è‡ªå‹•Issueä½œæˆ

on:
  workflow_dispatch:
    inputs:
      issue_type:
        description: 'Type of issue to create'
        required: true
        type: choice
        options:
          - bug
          - feature
          - documentation

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  auto-create-issue:
    name: Auto Create Issue for Branch
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Check if branch has issue number
        uses: actions/github-script@v7
        with:
          script: |
            // PRã®å ´åˆã¯head_refã€pushã®å ´åˆã¯ref_name
            const branch = context.payload.pull_request
              ? context.payload.pull_request.head.ref
              : context.ref.replace('refs/heads/', '');

            console.log(`Checking branch: ${branch}`);

            // Issueç•ªå·ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ (Work Unit Systemå¯¾å¿œ)
            const hasIssueNumber = /^(feature|hotfix|docs|test|fix)\/\d+-/.test(branch);

            if (hasIssueNumber) {
              console.log('âœ… Branch already has issue number');
              return;
            }

            console.log('âš ï¸  Branch does not have issue number, auto-creating issue...');

            // ãƒ–ãƒ©ãƒ³ãƒåã‹ã‚‰èª¬æ˜ã‚’æŠ½å‡º
            const description = branch
              .replace(/^(feature|hotfix|docs|test|fix)\//, '')
              .replace(/-/g, ' ')
              .trim();

            const branchType = branch.match(/^(\w+)\//)?.[1] || 'feature';

            // è‡ªå‹•Issueä½œæˆï¼ˆã¾ãšissue.numberãªã—ã§ä½œæˆï¼‰
            const { data: issue } = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ¤– Auto: ${description}`,
              body: 'ä½œæˆä¸­...',  // ä¸€æ™‚çš„ãªå†…å®¹
              labels: ['auto-created', 'needs-review']
            });

            // Issueç•ªå·ãŒåˆ©ç”¨å¯èƒ½ã«ãªã£ãŸã®ã§ã€æœ¬æ–‡ã‚’æ›´æ–°
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: [
                '## ğŸ¤– è‡ªå‹•ä½œæˆã•ã‚ŒãŸIssue',
                '',
                `ã“ã®Issueã¯ã€Issueç•ªå·ãªã—ã®ãƒ–ãƒ©ãƒ³ãƒ \`${branch}\` ã«å¯¾ã—ã¦è‡ªå‹•çš„ã«ä½œæˆã•ã‚Œã¾ã—ãŸã€‚`,
                '',
                '### ãƒ–ãƒ©ãƒ³ãƒæƒ…å ±',
                `- **ãƒ–ãƒ©ãƒ³ãƒå**: \`${branch}\``,
                `- **ã‚¿ã‚¤ãƒ—**: ${branchType}`,
                `- **ä½œæˆç†ç”±**: Issueç•ªå·ãŒå«ã¾ã‚Œã¦ã„ãªã„ãŸã‚`,
                '',
                '### æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—',
                '',
                '#### æ¨å¥¨: ãƒ–ãƒ©ãƒ³ãƒã‚’æ­£ã—ã„å½¢å¼ã§ä½œã‚Šç›´ã™',
                '',
                '```bash',
                `git checkout -b ${branchType}/${issue.number}-${description.replace(/ /g, '-')}`,
                'git cherry-pick {ç¾åœ¨ã®ã‚³ãƒŸãƒƒãƒˆ}',
                `git push -u origin ${branchType}/${issue.number}-${description.replace(/ /g, '-')}`,
                '```',
                '',
                '#### ã¾ãŸã¯: ã“ã®Issueã‚’ãã®ã¾ã¾ä½¿ç”¨',
                '',
                'ã“ã®Issueç•ªå·ã‚’ãƒ–ãƒ©ãƒ³ãƒåã‚„ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«è¿½åŠ ã—ã¦ãã ã•ã„:',
                '',
                '```bash',
                `# ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ä¾‹`,
                `git commit -m "feat: #${issue.number} ${description}"`,
                '```',
                '',
                '### ãªãœã“ã‚ŒãŒå¿…è¦ï¼Ÿ',
                '',
                '- Issue-PR-Closeã‚µã‚¤ã‚¯ãƒ«ã®å®Œå…¨æ€§ã‚’ä¿è¨¼',
                '- å¤‰æ›´ã®è¿½è·¡å¯èƒ½æ€§ã‚’ç¢ºä¿',
                '- LLMã¨ã‚¬ãƒ¼ãƒ‰ãƒ¬ãƒ¼ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã®é€£æº',
                '',
                '### å‚è€ƒ',
                '',
                '- [AIé§†å‹•ãƒ–ãƒ©ãƒ³ãƒæˆ¦ç•¥](../docs/AI_DRIVEN_BRANCHING.md)',
                '- [ã‚³ãƒ³ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã‚¬ã‚¤ãƒ‰](../docs/CONTRIBUTING.md)',
                '',
                '---',
                '',
                'ğŸ¤– ã“ã®Issueã¯ã‚¬ãƒ¼ãƒ‰ãƒ¬ãƒ¼ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã«ã‚ˆã£ã¦è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚',
                '',
                `Created by: ${context.actor}`,
                `Branch: ${branch}`,
                `Commit: ${context.sha.substring(0, 7)}`
              ].join('\n')
            });

            console.log(`âœ… Created issue #${issue.number}: ${issue.title}`);

            // PRã®å ´åˆã€ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ 
            if (context.payload.pull_request) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: [
                  `## ğŸ¤– Issueç•ªå·ãŒè‡ªå‹•ä½œæˆã•ã‚Œã¾ã—ãŸ`,
                  '',
                  `ã“ã®PRã®ãƒ–ãƒ©ãƒ³ãƒ \`${branch}\` ã«ã¯Issueç•ªå·ãŒå«ã¾ã‚Œã¦ã„ãªã‹ã£ãŸãŸã‚ã€`,
                  `è‡ªå‹•çš„ã« **Issue #${issue.number}** ã‚’ä½œæˆã—ã¾ã—ãŸã€‚`,
                  '',
                  '### æ¨å¥¨ã•ã‚Œã‚‹å¯¾å¿œ',
                  '',
                  '1. **PRã‚¿ã‚¤ãƒˆãƒ«ã‚’æ›´æ–°**:',
                  `   - ç¾åœ¨: ${context.payload.pull_request.title}`,
                  `   - æ¨å¥¨: \`feat: #${issue.number} ${description}\``,
                  '',
                  '2. **PRæœ¬æ–‡ã‚’æ›´æ–°**:',
                  `   - \`Closes #${issue.number}\` ã‚’è¿½åŠ `,
                  '',
                  '3. **ã¾ãŸã¯ã€ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œã‚Šç›´ã™** (æ¨å¥¨):',
                  '   ```bash',
                  `   git checkout -b ${branchType}/${issue.number}-${description.replace(/ /g, '-')}`,
                  '   git cherry-pick {ç¾åœ¨ã®ã‚³ãƒŸãƒƒãƒˆ}',
                  `   git push -u origin ${branchType}/${issue.number}-${description.replace(/ /g, '-')}`,
                  '   ```',
                  '',
                  '### ä½œæˆã•ã‚ŒãŸIssue',
                  '',
                  `- **Issue**: #${issue.number}`,
                  `- **ã‚¿ã‚¤ãƒˆãƒ«**: ${issue.title}`,
                  `- **URL**: ${issue.html_url}`,
                  '',
                  '---',
                  '',
                  'ğŸ’¡ ä»Šå¾Œã¯ã€ãƒ–ãƒ©ãƒ³ãƒä½œæˆå‰ã«å¿…ãšIssueã‚’ä½œæˆã™ã‚‹ã‹ã€',
                  `æ­£ã—ã„å½¢å¼ï¼ˆ\`${branchType}/#{Issueç•ªå·}-{èª¬æ˜}\`ï¼‰ã§ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚`
                ].join('\n')
              });
            }

            // pushã®å ´åˆã€æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆPRã‚³ãƒ¡ãƒ³ãƒˆä¸å¯ã®ãŸã‚ï¼‰
            console.log('');
            console.log('ğŸ“§ Push detected, issue created but cannot comment on PR (no PR exists yet)');
            console.log(`Please reference issue #${issue.number} in your commits and PR`);
