# Event Model v1 - STREAM A: PR-Lifecycle
# Purpose: Enable auto-merge for approved PRs
# Triggers: pull_request_review
# Dependencies: None
# Last updated: 2025-11-23

name: ✅ PR自動マージ有効化

on:
  pull_request:
    types: [opened, ready_for_review]

permissions:
  contents: write
  pull-requests: write

jobs:
  enable-auto-merge:
    name: Enable GitHub Native Auto-Merge
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: github.event.pull_request.draft == false

    steps:
      - name: Enable auto-merge
        env:
          # Use PAT to trigger pull_request_target workflows (e.g., Wiki Update Agent)
          # GITHUB_TOKEN doesn't trigger subsequent workflows to prevent infinite loops
          # See: https://docs.github.com/actions/security-guides/automatic-token-authentication
          GH_TOKEN: ${{ secrets.PAT_FOR_HEALTH_CHECK }}
        run: |
          # GitHub Native Auto-Mergeを有効化
          gh pr merge ${{ github.event.pull_request.number }} \
            --auto \
            --squash \
            --repo ${{ github.repository }}

          echo "✅ Auto-merge enabled for PR #${{ github.event.pull_request.number }}"

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: '✅ GitHub Native Auto-Mergeが有効になりました\n\n' +
                '- 全ての必須チェックが完了すると自動的にマージされます\n' +
                '- マージ方式: Squash and merge\n' +
                '- ブランチは自動削除されます'
            });
