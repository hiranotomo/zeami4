# Event Model v1 - STREAM B: Meta-Operations
# Purpose: Auto-assign milestone to issues
# Triggers: issues (opened, reopened)
# Dependencies: None
# Last updated: 2025-11-23

name: â„¹ï¸ ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³è‡ªå‹•è¨­å®š

on:
  issues:
    types: [opened, edited]

permissions:
  issues: write

jobs:
  assign-milestone:
    name: Auto Assign Milestone
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      issues: write

    steps:
      - name: Assign Milestone Based on Title
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const title = issue.title;

            console.log(`Processing Issue #${issue.number}: ${title}`);

            // æ—¢ã«MilestoneãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
            if (issue.milestone) {
              console.log(`âœ… Milestone already set: ${issue.milestone.title}`);
              return;
            }

            // Milestoneè¨­å®šãƒ«ãƒ¼ãƒ«ï¼ˆå°†æ¥çš„ã«ã¯è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿å¯èƒ½ï¼‰
            const milestoneRules = [
              // ãƒ•ã‚§ãƒ¼ã‚ºå­¦ç¿’ç”¨
              { pattern: /ãƒ•ã‚§ãƒ¼ã‚º0|phase\s*0/i, milestone: 'ãƒ•ã‚§ãƒ¼ã‚º0: ãƒ¡ã‚¿ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—' },
              { pattern: /ãƒ•ã‚§ãƒ¼ã‚º1|phase\s*1/i, milestone: 'ãƒ•ã‚§ãƒ¼ã‚º1: GitHub ActionsåŸºç¤ç†è§£' },
              { pattern: /ãƒ•ã‚§ãƒ¼ã‚º2|phase\s*2/i, milestone: 'ãƒ•ã‚§ãƒ¼ã‚º2: LLMçµ±åˆã®æ¦‚å¿µ' },
              { pattern: /ãƒ•ã‚§ãƒ¼ã‚º3|phase\s*3/i, milestone: 'ãƒ•ã‚§ãƒ¼ã‚º3: è‡ªå‹•åŒ–ã®è¨­è¨ˆæ€æƒ³' },
              { pattern: /ãƒ•ã‚§ãƒ¼ã‚º4|phase\s*4/i, milestone: 'ãƒ•ã‚§ãƒ¼ã‚º4: E2Eãƒ†ã‚¹ãƒˆæˆ¦ç•¥' },
              { pattern: /ãƒ•ã‚§ãƒ¼ã‚º5|phase\s*5/i, milestone: 'ãƒ•ã‚§ãƒ¼ã‚º5: é‹ç”¨ã¨æœ€é©åŒ–' },

              // ãã®ä»–ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆå°†æ¥çš„ã«è¿½åŠ å¯èƒ½ï¼‰
              { pattern: /ãƒã‚°|bug|fix/i, milestone: 'Bug Fixes' },
              { pattern: /æ©Ÿèƒ½|feature|feat/i, milestone: 'New Features' },
              { pattern: /ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ|docs?|documentation/i, milestone: 'Documentation' },
              { pattern: /ãƒ†ã‚¹ãƒˆ|test/i, milestone: 'Testing' },
              { pattern: /ãƒªãƒ•ã‚¡ã‚¯ã‚¿|refactor/i, milestone: 'Refactoring' },
              { pattern: /ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£|security/i, milestone: 'Security' },
            ];

            // ã‚¿ã‚¤ãƒˆãƒ«ã‹ã‚‰Milestoneã‚’æ¤œå‡º
            let targetMilestoneName = null;
            for (const rule of milestoneRules) {
              if (rule.pattern.test(title)) {
                targetMilestoneName = rule.milestone;
                console.log(`ğŸ“Œ Pattern matched: ${rule.pattern} â†’ ${targetMilestoneName}`);
                break;
              }
            }

            // ãƒãƒƒãƒã™ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆã‚¨ãƒ©ãƒ¼ã«ã—ãªã„ï¼‰
            if (!targetMilestoneName) {
              console.log('â„¹ï¸ No matching pattern found. Skipping milestone assignment.');
              return;
            }

            // æ—¢å­˜ã®Milestoneã‚’å–å¾—
            try {
              const { data: milestones } = await github.rest.issues.listMilestones({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                per_page: 100
              });

              console.log(`ğŸ“Š Found ${milestones.length} open milestones`);

              // å®Œå…¨ä¸€è‡´ã¾ãŸã¯éƒ¨åˆ†ä¸€è‡´ã§Milestoneã‚’æ¤œç´¢
              let milestone = milestones.find(m => m.title === targetMilestoneName);

              // å®Œå…¨ä¸€è‡´ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã€éƒ¨åˆ†ä¸€è‡´ã‚’è©¦ã™
              if (!milestone) {
                milestone = milestones.find(m =>
                  m.title.includes(targetMilestoneName) ||
                  targetMilestoneName.includes(m.title)
                );
              }

              if (!milestone) {
                console.log(`âš ï¸ Milestone "${targetMilestoneName}" not found.`);
                console.log('Available milestones:', milestones.map(m => m.title).join(', '));

                // MilestoneãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã€ã‚³ãƒ¡ãƒ³ãƒˆã§é€šçŸ¥ï¼ˆã‚¨ãƒ©ãƒ¼ã«ã¯ã—ãªã„ï¼‰
                const commentBody = [
                  `â„¹ï¸ Milestoneå€™è£œã€Œ${targetMilestoneName}ã€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚`,
                  '',
                  'å¿…è¦ã«å¿œã˜ã¦ã€ä»¥ä¸‹ã®ã„ãšã‚Œã‹ã‚’è¡Œã£ã¦ãã ã•ã„:',
                  '1. æ–°ã—ã„Milestoneã‚’ä½œæˆã™ã‚‹',
                  '2. æ—¢å­˜ã®Milestoneã‹ã‚‰é¸æŠã—ã¦æ‰‹å‹•ã§è¨­å®šã™ã‚‹',
                  '',
                  'åˆ©ç”¨å¯èƒ½ãªMilestone:',
                  milestones.length > 0 ? milestones.map(m => `- ${m.title}`).join('\n') : 'ï¼ˆãªã—ï¼‰'
                ].join('\n');

                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: commentBody
                });
                return;
              }

              console.log(`âœ… Found milestone: ${milestone.title} (ID: ${milestone.number})`);

              // Milestoneã‚’è¨­å®š
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                milestone: milestone.number
              });

              console.log(`âœ… Milestone "${milestone.title}" assigned to Issue #${issue.number}`);

              // æˆåŠŸã‚³ãƒ¡ãƒ³ãƒˆ
              const successComment = [
                `âœ… Milestoneã€Œ**${milestone.title}**ã€ã‚’è‡ªå‹•è¨­å®šã—ã¾ã—ãŸã€‚`,
                '',
                'ã“ã®Milestoneã¯ã€Issueã‚¿ã‚¤ãƒˆãƒ«ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°ã«ã‚ˆã‚Šè‡ªå‹•çš„ã«é¸æŠã•ã‚Œã¾ã—ãŸã€‚',
                'å¿…è¦ã«å¿œã˜ã¦ã€æ‰‹å‹•ã§å¤‰æ›´ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚'
              ].join('\n');

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: successComment
              });

            } catch (error) {
              console.error('Error in milestone assignment:', error);
              // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼è‡ªä½“ã¯å¤±æ•—ã•ã›ãªã„
              console.log('âš ï¸ Milestone assignment failed, but continuing workflow.');
            }

      - name: Check Milestone Progression
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const title = issue.title;

            // ãƒ•ã‚§ãƒ¼ã‚ºç•ªå·ã‚’æŠ½å‡º
            const phaseMatch = title.match(/ãƒ•ã‚§ãƒ¼ã‚º(\d+)|phase\s*(\d+)/i);

            if (!phaseMatch) {
              console.log('Not a phase-related issue, skipping progression check');
              return;
            }

            const requestedPhase = parseInt(phaseMatch[1] || phaseMatch[2]);
            console.log(`Requested phase: ${requestedPhase}`);

            // ãƒ•ã‚§ãƒ¼ã‚º0ã®å ´åˆã¯ãƒã‚§ãƒƒã‚¯ä¸è¦
            if (requestedPhase === 0) {
              console.log('Phase 0 does not require progression check');
              return;
            }

            // å‰ã®ãƒ•ã‚§ãƒ¼ã‚ºã®Milestoneã‚’å–å¾—
            const { data: milestones } = await github.rest.issues.listMilestones({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all',
              per_page: 100
            });

            const previousPhaseNum = requestedPhase - 1;
            const previousMilestone = milestones.find(m =>
              m.title.includes(`ãƒ•ã‚§ãƒ¼ã‚º${previousPhaseNum}`)
            );

            if (!previousMilestone) {
              console.log(`Previous phase milestone not found: ãƒ•ã‚§ãƒ¼ã‚º${previousPhaseNum}`);
              return;
            }

            // å‰ã®ãƒ•ã‚§ãƒ¼ã‚ºãŒå®Œäº†ï¼ˆclosedï¼‰ã—ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            if (previousMilestone.state === 'open') {
              console.log(`âš ï¸ Previous phase is still open: ${previousMilestone.title}`);

              const warningMessage = [
                `## âš ï¸ å‰ã®ãƒ•ã‚§ãƒ¼ã‚ºãŒæœªå®Œäº†ã§ã™`,
                '',
                `ã“ã®Issueã¯ã€Œãƒ•ã‚§ãƒ¼ã‚º${requestedPhase}ã€ã«é–¢é€£ã—ã¦ã„ã¾ã™ãŒã€**å‰ã®ãƒ•ã‚§ãƒ¼ã‚ºï¼ˆãƒ•ã‚§ãƒ¼ã‚º${previousPhaseNum}ï¼‰ãŒã¾ã å®Œäº†ã—ã¦ã„ã¾ã›ã‚“**ã€‚`,
                '',
                '### æ¨å¥¨äº‹é …:',
                `1. ã¾ãš [ãƒ•ã‚§ãƒ¼ã‚º${previousPhaseNum}: ${previousMilestone.title}](${previousMilestone.html_url}) ã‚’å®Œäº†ã•ã›ã¦ãã ã•ã„`,
                '2. æ®µéšçš„ãªå­¦ç¿’ã«ã‚ˆã‚Šã€ç†è§£ãŒæ·±ã¾ã‚Šã¾ã™',
                '',
                '### ã“ã®Issueã‚’é€²ã‚ãŸã„å ´åˆ:',
                '- é †åºã‚’é£›ã°ã™ç†ç”±ãŒã‚ã‚‹å ´åˆã¯ã€ãã®ã¾ã¾ã“ã®Issueã‚’é€²ã‚ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™',
                '- ãŸã ã—ã€å‰æçŸ¥è­˜ãŒä¸è¶³ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã“ã¨ã‚’ç†è§£ã—ã¦ãã ã•ã„',
                '',
                'ğŸ’¡ **ãƒ’ãƒ³ãƒˆ**: ã“ã®ãƒã‚§ãƒƒã‚¯ã¯å¼·åˆ¶ã§ã¯ãªãã€ã‚ãã¾ã§æ¨å¥¨ã§ã™ã€‚'
              ].join('\n');

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: warningMessage
              });
            } else {
              console.log(`âœ… Previous phase is completed: ${previousMilestone.title}`);
            }