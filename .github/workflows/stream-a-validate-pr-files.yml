# Event Model v1 - STREAM A: PR-Lifecycle
# Purpose: Validate required files in PR & Issue DoD checkboxes
# Triggers: pull_request
# Dependencies: None
# Last updated: 2025-11-24

name: Validate Required Files

on:
  pull_request:
    types: [opened, synchronize, edited]

permissions:
  contents: read
  pull-requests: write
  issues: read

jobs:
  check-required-files:
    name: Check Required File Changes
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check Phase Completion Files
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const title = pr.title;

            console.log(`Checking PR: ${title}`);

            // ãƒ•ã‚§ãƒ¼ã‚ºå®Œäº†PRã®åˆ¤å®š
            const phaseCompletionPattern = /ãƒ•ã‚§ãƒ¼ã‚º(\d+).*å®Œäº†|phase\s*(\d+).*complete/i;
            const match = title.match(phaseCompletionPattern);

            if (!match) {
              console.log('Not a phase completion PR, skipping file check');
              return;
            }

            const phaseNum = match[1] || match[2];
            console.log(`Detected phase completion PR: Phase ${phaseNum}`);

            // PRã§å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number
            });

            console.log(`Files changed: ${files.length}`);

            // ========== ãƒ†ã‚¹ãƒˆè¿½åŠ ã®æ¤œè¨¼ ==========

            // ãƒ†ã‚¹ãƒˆè¿½åŠ ã®æ¤œè¨¼
            const sourceChanges = files.filter(f =>
              f.filename.startsWith('src/') &&
              !f.filename.includes('.spec.') &&
              !f.filename.includes('.test.') &&
              (f.filename.endsWith('.ts') || f.filename.endsWith('.js'))
            );

            const testChanges = files.filter(f =>
              f.filename.includes('.spec.') ||
              f.filename.includes('.test.') ||
              f.filename.startsWith('tests/')
            );

            console.log(`Source files changed: ${sourceChanges.length}`);
            console.log(`Test files changed: ${testChanges.length}`);

            // ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ãŒå¤‰æ›´ã•ã‚Œã¦ã„ã‚‹ã®ã«ãƒ†ã‚¹ãƒˆãŒãªã„å ´åˆ
            if (sourceChanges.length > 0 && testChanges.length === 0) {
              const warningMessage = [
                '## âš ï¸ ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“',
                '',
                'ã“ã®PRã¯ä»¥ä¸‹ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¦ã„ã¾ã™ãŒã€ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ãŒã‚ã‚Šã¾ã›ã‚“:',
                '',
                sourceChanges.map(f => `- \`${f.filename}\``).join('\n'),
                '',
                '### æ¨å¥¨äº‹é …:',
                '1. æ–°æ©Ÿèƒ½ã«ã¯ãƒ†ã‚¹ãƒˆã‚’è¿½åŠ ã—ã¦ãã ã•ã„',
                '2. ãƒã‚°ä¿®æ­£ã®å ´åˆã‚‚ã€å†ç™ºé˜²æ­¢ã®ãƒ†ã‚¹ãƒˆã‚’è¿½åŠ ã—ã¦ãã ã•ã„',
                '3. ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã®å ´åˆã¯ã€æ—¢å­˜ãƒ†ã‚¹ãƒˆãŒé€šã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„',
                '',
                '### ä¾‹å¤–ã‚±ãƒ¼ã‚¹:',
                'ä»¥ä¸‹ã®å ´åˆã¯ãƒ†ã‚¹ãƒˆãªã—ã§ã‚‚å•é¡Œã‚ã‚Šã¾ã›ã‚“:',
                '- ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ã¿ã®å¤‰æ›´',
                '- å‹å®šç¾©ã®ã¿ã®å¤‰æ›´',
                '- è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã®å¤‰æ›´',
                '',
                'ãã®å ´åˆã¯ã€PRã®æœ¬æ–‡ã«ãã®æ—¨ã‚’è¨˜è¼‰ã—ã¦ãã ã•ã„ã€‚'
              ].join('\n');

              core.warning('âš ï¸ ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ãŒã‚ã‚Šã¾ã›ã‚“');

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: warningMessage
              });
            } else if (sourceChanges.length > 0 && testChanges.length > 0) {
              console.log('âœ… Both source and test files are changed');
            }

            // ========== ãƒ†ã‚¹ãƒˆè¿½åŠ ã®æ¤œè¨¼ã“ã“ã¾ã§ ==========

      - name: Validate Issue DoD Checklist
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const prBody = pr.body || '';
            const prTitle = pr.title;

            // Extract issue number from PR title or body
            const issuePatterns = [
              /[Ii]ssue\s*#(\d+)/,
              /[Cc]loses?\s*#(\d+)/,
              /[Ff]ixes?\s*#(\d+)/,
              /#(\d+)/
            ];

            let issueNumber = null;

            // Check PR title first
            for (const pattern of issuePatterns) {
              const match = prTitle.match(pattern);
              if (match) {
                issueNumber = match[1];
                break;
              }
            }

            // Check PR body if not found
            if (!issueNumber) {
              for (const pattern of issuePatterns) {
                const match = prBody.match(pattern);
                if (match) {
                  issueNumber = match[1];
                  break;
                }
              }
            }

            if (!issueNumber) {
              core.notice('âš ï¸ No issue reference found - skipping DoD validation');
              return;
            }

            console.log(`Found issue reference: #${issueNumber}`);

            // Fetch issue to check DoD checkboxes
            try {
              const { data: issue } = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: parseInt(issueNumber)
              });

              const issueBody = issue.body || '';

              // Count checkboxes
              const totalCheckboxes = (issueBody.match(/- \[[ xX]\]/g) || []).length;
              const checkedCheckboxes = (issueBody.match(/- \[xX\]/g) || []).length;
              const uncheckedCheckboxes = totalCheckboxes - checkedCheckboxes;

              console.log(`Issue #${issueNumber} DoD: ${checkedCheckboxes}/${totalCheckboxes} items completed`);

              if (totalCheckboxes === 0) {
                core.warning(`Issue #${issueNumber} has no DoD checkboxes`);
                return;
              }

              if (uncheckedCheckboxes > 0) {
                const warningMessage = [
                  `## âš ï¸ Issue DoD Incomplete`,
                  '',
                  `Issue [#${issueNumber}](${issue.html_url}): "${issue.title}"`,
                  '',
                  `ğŸ“Š Progress: ${checkedCheckboxes}/${totalCheckboxes} items completed (**${uncheckedCheckboxes} remaining**)`,
                  '',
                  '### âš ï¸ Action Required',
                  `Please complete all DoD checkboxes in Issue #${issueNumber} before merging this PR.`,
                  '',
                  '**Update the issue using:**',
                  '```bash',
                  `gh issue edit ${issueNumber}`,
                  '```',
                  '',
                  '---',
                  'ğŸ¤– Automated DoD validation'
                ].join('\n');

                core.warning(`âš ï¸ Issue #${issueNumber}: ${uncheckedCheckboxes} DoD item(s) unchecked`);

                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  body: warningMessage
                });
              } else {
                console.log(`âœ… Issue #${issueNumber}: All DoD checkboxes completed`);

                const successMessage = [
                  `## âœ… Issue DoD Completed`,
                  '',
                  `Issue [#${issueNumber}](${issue.html_url}) has all ${totalCheckboxes} DoD checkboxes checked.`,
                  '',
                  'âœ¨ Ready to merge!',
                  '',
                  '---',
                  'ğŸ¤– Automated DoD validation'
                ].join('\n');

                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  body: successMessage
                });
              }
            } catch (error) {
              core.warning(`Failed to fetch issue #${issueNumber}: ${error.message}`);
            }

      - name: Check Phase Completion Files (continued)
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const title = pr.title;

            const phaseCompletionPattern = /ãƒ•ã‚§ãƒ¼ã‚º(\d+).*å®Œäº†|phase\s*(\d+).*complete/i;
            const match = title.match(phaseCompletionPattern);

            if (!match) {
              console.log('Not a phase completion PR, skipping file check');
              return;
            }

            const phaseNum = match[1] || match[2];

            // PRã§å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number
            });

            // å¿…é ˆãƒ•ã‚¡ã‚¤ãƒ«ã®å®šç¾©
            const requiredFiles = [
              `docs/learning/phase${phaseNum}/notes.md`
            ];

            const missingFiles = [];

            for (const reqFile of requiredFiles) {
              const hasFile = files.some(f => f.filename === reqFile);

              if (!hasFile) {
                // ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆæ–°è¦ä½œæˆã®å ´åˆã‚‚ã‚ã‚‹ãŸã‚ï¼‰
                try {
                  await github.rest.repos.getContent({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    path: reqFile,
                    ref: pr.head.ref
                  });
                  console.log(`âœ… ${reqFile} exists (not changed in this PR)`);
                } catch (error) {
                  if (error.status === 404) {
                    missingFiles.push(reqFile);
                    console.log(`âŒ ${reqFile} is missing`);
                  }
                }
              } else {
                console.log(`âœ… ${reqFile} is changed in this PR`);
              }
            }

            if (missingFiles.length > 0) {
              const errorMessage = [
                `## âŒ å¿…é ˆãƒ•ã‚¡ã‚¤ãƒ«ã®æ›´æ–°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`,
                '',
                `ã“ã®PRã¯ã€Œãƒ•ã‚§ãƒ¼ã‚º${phaseNum}å®Œäº†ã€ã‚’ç¤ºã—ã¦ã„ã¾ã™ãŒã€ä»¥ä¸‹ã®å¿…é ˆãƒ•ã‚¡ã‚¤ãƒ«ãŒæ›´æ–°ã•ã‚Œã¦ã„ã¾ã›ã‚“:`,
                '',
                missingFiles.map(f => `- \`${f}\``).join('\n'),
                '',
                '### ä¿®æ­£æ–¹æ³•:',
                `1. å­¦ç¿’ãƒ¡ãƒ¢ã‚’ \`docs/learning/phase${phaseNum}/notes.md\` ã«è¨˜å…¥ã—ã¦ãã ã•ã„`,
                '2. å­¦ã‚“ã ã“ã¨ã€æ°—ã¥ã„ãŸã“ã¨ã€ã¤ã¾ãšã„ãŸç‚¹ãªã©ã‚’è¨˜éŒ²ã—ã¦ãã ã•ã„',
                '',
                '### ãªãœå¿…è¦ï¼Ÿ',
                '- å­¦ç¿’ãƒ—ãƒ­ã‚»ã‚¹ã®å®Œå…¨æ€§ã‚’ä¿è¨¼',
                '- ã€Œã‚„ã£ãŸã¤ã‚‚ã‚Šã€ã‚’é˜²ã',
                '- æŒ¯ã‚Šè¿”ã‚Šã¨çŸ¥è­˜å®šç€ã®ãŸã‚'
              ].join('\n');

              core.setFailed(`âŒ å¿…é ˆãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${missingFiles.join(', ')}`);

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: errorMessage
              });
            } else {
              console.log('âœ… All required files are present');

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: `âœ… ãƒ•ã‚§ãƒ¼ã‚º${phaseNum}å®Œäº†ã®å¿…é ˆãƒ•ã‚¡ã‚¤ãƒ«ãŒç¢ºèªã§ãã¾ã—ãŸã€‚`
              });
            }
