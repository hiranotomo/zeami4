# Event Model v1 - STREAM B: Meta-Operations
# Purpose: Wiki migration operations
# Triggers: workflow_dispatch
# Dependencies: None
# Last updated: 2025-11-23

name: üìö Wiki Migration

on:
  pull_request:
    types: [closed]
    paths:
      - 'docs/**/*.md'

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  check-and-migrate:
    name: Check and Migrate Docs to Wiki
    # Only run on merged PRs AND skip on push events (workflow only designed for pull_request context)
    if: github.event_name == 'pull_request' && github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed docs files
        id: changed-files
        run: |
          # Get list of changed files in docs/
          CHANGED_DOCS=$(gh pr view ${{ github.event.pull_request.number }} \
            --json files --jq '.files[].path' | grep '^docs/.*\.md$' || true)

          echo "Changed docs files:"
          echo "$CHANGED_DOCS"

          # Save to output
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_DOCS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # Count files
          COUNT=$(echo "$CHANGED_DOCS" | grep -c '.' || echo "0")
          echo "count=$COUNT" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check against allowed list
        id: check-allowed
        if: steps.changed-files.outputs.count > 0
        run: |
          # Define allowed local docs (keep these in repo)
          ALLOWED_LIST=(
            "README.md"
            "CONTRIBUTING.md"
            "CHANGELOG.md"
            "LICENSE.md"
          )

          NEEDS_MIGRATION=""

          while IFS= read -r file; do
            [[ -z "$file" ]] && continue

            BASENAME=$(basename "$file")
            ALLOWED=false

            for allowed in "${ALLOWED_LIST[@]}"; do
              if [[ "$BASENAME" == "$allowed" ]]; then
                ALLOWED=true
                echo "‚úÖ Allowed: $file"
                break
              fi
            done

            if [[ "$ALLOWED" == "false" ]]; then
              echo "‚ö†Ô∏è Needs migration: $file"
              NEEDS_MIGRATION="${NEEDS_MIGRATION}${file}"$'\n'
            fi
          done <<< "${{ steps.changed-files.outputs.files }}"

          echo "migration-files<<EOF" >> $GITHUB_OUTPUT
          echo "$NEEDS_MIGRATION" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          MIGRATION_COUNT=$(echo "$NEEDS_MIGRATION" | grep -c '.' || echo "0")
          echo "migration-count=$MIGRATION_COUNT" >> $GITHUB_OUTPUT

      - name: Post migration warning
        if: steps.check-allowed.outputs.migration-count > 0
        uses: actions/github-script@v7
        with:
          script: |
            const files = `${{ steps.check-allowed.outputs.migration-files }}`.trim().split('\n').filter(f => f);

            const body = `## ‚ö†Ô∏è „Éâ„Ç≠„É•„É°„É≥„ÉàÁßªË°å„ÅåÂøÖË¶Å„Åß„Åô

„Åì„ÅÆPR„Åß‰ª•‰∏ã„ÅÆ„Éï„Ç°„Ç§„É´„Åå \`docs/\` ÈÖç‰∏ã„Å´‰ΩúÊàê/Êõ¥Êñ∞„Åï„Çå„Åæ„Åó„ÅüÔºö

${files.map(f => `- \`${f}\``).join('\n')}

### üìö WikiÁßªË°å„Éù„É™„Ç∑„Éº

„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆ„Éâ„Ç≠„É•„É°„É≥„Éà„ÅØ **GitHub Wiki** „ÅßÁÆ°ÁêÜ„Åó„Å¶„ÅÑ„Åæ„ÅôÔºàIssue #351Ôºâ„ÄÇ

### üîß ÂøÖË¶Å„Å™„Ç¢„ÇØ„Ç∑„Éß„É≥

1. **Wiki Migration Agent „ÇíËµ∑Âãï**
   - „Åì„Çå„Çâ„ÅÆ„Éï„Ç°„Ç§„É´„ÇíWiki„Å´ÁßªË°å„Åó„Åæ„Åô
   - „É≠„Éº„Ç´„É´„Éï„Ç°„Ç§„É´„ÇíÂâäÈô§„Åô„ÇãPR„Çí‰ΩúÊàê„Åó„Åæ„Åô

2. **ÊâãÂãï„Åß„ÅÆÁßªË°å**ÔºàAgentÊú™ÂØæÂøú„ÅÆÂ†¥ÂêàÔºâ
   - Wiki„Å´„Éö„Éº„Ç∏„Çí‰ΩúÊàê: https://github.com/${context.repo.owner}/${context.repo.repo}/wiki
   - ÂÜÖÂÆπ„Çí„Ç≥„Éî„ÉºÔºÜ„Éö„Éº„Çπ„Éà
   - „É≠„Éº„Ç´„É´„Éï„Ç°„Ç§„É´„ÇíÂâäÈô§„Åô„ÇãPR‰ΩúÊàê

### üìñ Èñ¢ÈÄ£

- Issue #421: WikiÁßªË°å„É´„Éº„É´ÂæπÂ∫ï„ÅÆ‰ªïÁµÑ„ÅøÂåñ
- Issue #351: WikiÁßªË°åÂÆå‰∫Ü
- [Wiki „Éâ„Ç≠„É•„É°„É≥„ÉàÁÆ°ÁêÜ„Éù„É™„Ç∑„Éº](https://github.com/${context.repo.owner}/${context.repo.repo}/wiki/„Éâ„Ç≠„É•„É°„É≥„ÉàÁÆ°ÁêÜ„Éù„É™„Ç∑„Éº)

---

ü§ñ „Åì„ÅÆ„Ç≥„É°„É≥„Éà„ÅØËá™ÂãïÁîüÊàê„Åï„Çå„Åæ„Åó„Åü`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

      - name: Add wiki-migration label
        if: steps.check-allowed.outputs.migration-count > 0
        uses: actions/github-script@v7
        with:
          script: |
            try {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: ['wiki-migration']
              });
            } catch (error) {
              // Label might not exist, create it
              if (error.status === 422) {
                console.log('Label does not exist, skipping');
              } else {
                throw error;
              }
            }

      - name: Summary
        if: always()
        run: |
          echo "## üìö Wiki Migration Check Summary"
          echo ""
          echo "**Total docs files changed**: ${{ steps.changed-files.outputs.count }}"
          echo "**Files needing migration**: ${{ steps.check-allowed.outputs.migration-count }}"
          echo ""

          if [ "${{ steps.check-allowed.outputs.migration-count }}" -gt 0 ]; then
            echo "‚ö†Ô∏è Migration required - Check PR comments for details"
          else
            echo "‚úÖ No migration needed - All files are in allowed list"
          fi
