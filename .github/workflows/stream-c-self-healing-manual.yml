# Event Model v1 - STREAM C: Self-Healing/Monitoring
# Purpose: Manual self-healing trigger
# Triggers: workflow_dispatch
# Dependencies: None
# Last updated: 2025-11-23

name: ğŸ”§ æ‰‹å‹•è‡ªå·±ä¿®å¾©

on:
  workflow_dispatch:
    inputs:
      workflow_file:
        description: 'ä¿®å¾©ã™ã‚‹ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ï¼ˆä¾‹: .github/workflows/auto-create-issue.ymlï¼‰'
        required: true
        type: string
      error_description:
        description: 'ã‚¨ãƒ©ãƒ¼ã®èª¬æ˜'
        required: true
        type: string

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  analyze-and-fix:
    name: Analyze & Generate Fix
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      issue_number: ${{ steps.create-issue.outputs.issue_number }}
      branch_name: ${{ steps.create-branch.outputs.branch_name }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Read workflow file
        id: read-workflow
        run: |
          WORKFLOW_FILE="${{ github.event.inputs.workflow_file }}"

          if [ ! -f "$WORKFLOW_FILE" ]; then
            echo "âŒ Workflow file not found: $WORKFLOW_FILE"
            exit 1
          fi

          echo "âœ… Reading workflow file: $WORKFLOW_FILE"

          # ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹ã‚’èª­ã¿è¾¼ã¿ï¼ˆã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å‡¦ç†ï¼‰
          CONTENT=$(cat "$WORKFLOW_FILE" | jq -Rs .)
          echo "content=$CONTENT" >> $GITHUB_OUTPUT

      - name: Create Issue for fix
        id: create-issue
        uses: actions/github-script@v7
        with:
          script: |
            const workflowFile = ${{ toJSON(github.event.inputs.workflow_file) }};
            const errorDesc = ${{ toJSON(github.event.inputs.error_description) }};

            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ¤– Auto: Fix workflow bug in ${workflowFile.split('/').pop()}`,
              body: [
                '## ğŸ¤– è‡ªå·±ä¿®å¾©ã‚·ã‚¹ãƒ†ãƒ ã«ã‚ˆã‚‹è‡ªå‹•Issue',
                '',
                '### æ¤œå‡ºã•ã‚ŒãŸå•é¡Œ',
                '',
                `- **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼**: \`${workflowFile}\``,
                `- **ã‚¨ãƒ©ãƒ¼**: ${errorDesc}`,
                '',
                '### ä¿®å¾©ãƒ—ãƒ­ã‚»ã‚¹',
                '',
                '1. âœ… Issueä½œæˆï¼ˆã“ã®Issueï¼‰',
                '2. ğŸ”„ LLMã«ã‚ˆã‚‹ä¿®æ­£æ¡ˆç”Ÿæˆï¼ˆå®Ÿè¡Œä¸­...ï¼‰',
                '3. â³ PRä½œæˆï¼ˆè‡ªå‹•ï¼‰',
                '4. ğŸ‘€ äººé–“ã«ã‚ˆã‚‹ãƒ¬ãƒ“ãƒ¥ãƒ¼',
                '5. âœ… ãƒãƒ¼ã‚¸',
                '',
                '### æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—',
                '',
                'è‡ªå‹•çš„ã«PRãŒä½œæˆã•ã‚Œã¾ã™ã€‚ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦æ‰¿èªã—ã¦ãã ã•ã„ã€‚',
                '',
                '---',
                '',
                'ğŸ¤– ã“ã®Issueã¯è‡ªå·±ä¿®å¾©ã‚·ã‚¹ãƒ†ãƒ ã«ã‚ˆã£ã¦è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚',
                '',
                `Triggered by: @${context.actor}`,
                `Workflow: ${workflowFile}`
              ].join('\n'),
              labels: ['auto-healing', 'bug', 'needs-review']
            });

            console.log(`âœ… Created issue #${issue.data.number}`);
            core.setOutput('issue_number', issue.data.number);
            return issue.data.number;

      - name: Generate fix with Claude API
        id: generate-fix
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          WORKFLOW_FILE="${{ github.event.inputs.workflow_file }}"
          ERROR_DESC="${{ github.event.inputs.error_description }}"
          WORKFLOW_CONTENT=$(cat "$WORKFLOW_FILE")

          # Claude APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ä½œæˆ
          REQUEST_BODY=$(cat <<EOF
          {
            "model": "claude-sonnet-4-5-20250929",
            "max_tokens": 8192,
            "messages": [{
              "role": "user",
              "content": "ä»¥ä¸‹ã®GitHub Actionsãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã«ãƒã‚°ãŒã‚ã‚Šã¾ã™ã€‚ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚\n\n## ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«\n\`\`\`yaml\n${WORKFLOW_CONTENT}\n\`\`\`\n\n## ã‚¨ãƒ©ãƒ¼ã®èª¬æ˜\n${ERROR_DESC}\n\n## ã‚¿ã‚¹ã‚¯\n1. ãƒã‚°ã®åŸå› ã‚’ç‰¹å®šã—ã¦ãã ã•ã„\n2. ä¿®æ­£æ¡ˆã‚’ç”Ÿæˆã—ã¦ãã ã•ã„\n3. ä¿®æ­£å¾Œã®å®Œå…¨ãªYAMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„\n\n## å‡ºåŠ›å½¢å¼\nä»¥ä¸‹ã®å½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„:\n\n### åŸå› \n[ãƒã‚°ã®åŸå› ã®èª¬æ˜]\n\n### ä¿®æ­£å†…å®¹\n[ä½•ã‚’ä¿®æ­£ã—ãŸã‹]\n\n### ä¿®æ­£å¾Œã®ã‚³ãƒ¼ãƒ‰\n\`\`\`yaml\n[ä¿®æ­£å¾Œã®å®Œå…¨ãªYAMLãƒ•ã‚¡ã‚¤ãƒ«]\n\`\`\`"
            }]
          }
          EOF
          )

          echo "ğŸ¤– Calling Claude API..."

          # Claude APIã‚’å‘¼ã³å‡ºã—
          RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
            -H "Content-Type: application/json" \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -d "$REQUEST_BODY")

          # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ½å‡º
          FIX_CONTENT=$(echo "$RESPONSE" | jq -r '.content[0].text')

          if [ -z "$FIX_CONTENT" ] || [ "$FIX_CONTENT" = "null" ]; then
            echo "âŒ Failed to generate fix"
            echo "$RESPONSE" | jq .
            exit 1
          fi

          echo "âœ… Fix generated successfully"

          # ä¿®æ­£å†…å®¹ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          echo "$FIX_CONTENT" > /tmp/fix_explanation.md

          # YAMLã‚³ãƒ¼ãƒ‰ã‚’æŠ½å‡º
          echo "$FIX_CONTENT" | sed -n '/```yaml/,/```/p' | sed '1d;$d' > /tmp/fixed_workflow.yml

          if [ ! -s /tmp/fixed_workflow.yml ]; then
            echo "âŒ Failed to extract YAML from fix"
            exit 1
          fi

          echo "âœ… Extracted fixed YAML"

          # å‡ºåŠ›è¨­å®š
          echo "explanation<<EOF" >> $GITHUB_OUTPUT
          cat /tmp/fix_explanation.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create branch and commit fix
        id: create-branch
        run: |
          ISSUE_NUMBER=${{ steps.create-issue.outputs.issue_number }}
          WORKFLOW_FILE="${{ github.event.inputs.workflow_file }}"
          BRANCH_NAME="fix/${ISSUE_NUMBER}-auto-heal-workflow"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git checkout -b "$BRANCH_NAME"

          # ä¿®æ­£å†…å®¹ã‚’é©ç”¨
          cp /tmp/fixed_workflow.yml "$WORKFLOW_FILE"

          git add "$WORKFLOW_FILE"
          git commit -m "fix: #${ISSUE_NUMBER} Auto-heal $(basename $WORKFLOW_FILE)

          ğŸ¤– è‡ªå·±ä¿®å¾©ã‚·ã‚¹ãƒ†ãƒ ã«ã‚ˆã‚‹è‡ªå‹•ä¿®æ­£

          - ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«: $WORKFLOW_FILE
          - ã‚¨ãƒ©ãƒ¼: ${{ github.event.inputs.error_description }}

          ğŸ¤– Generated with Claude Code Self-Healing System

          Co-Authored-By: Claude <noreply@anthropic.com>"

          git push -u origin "$BRANCH_NAME"

          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "âœ… Branch created and pushed: $BRANCH_NAME"

      - name: Create Pull Request
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ steps.create-issue.outputs.issue_number }};
            const branchName = ${{ toJSON(steps.create-branch.outputs.branch_name) }};
            const workflowFile = ${{ toJSON(github.event.inputs.workflow_file) }};
            const explanation = ${{ toJSON(steps.generate-fix.outputs.explanation) }};

            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `fix: #${issueNumber} Auto-heal ${workflowFile.split('/').pop()}`,
              head: branchName,
              base: 'main',
              body: [
                `Closes #${issueNumber}`,
                '',
                '## ğŸ¤– è‡ªå·±ä¿®å¾©ã‚·ã‚¹ãƒ†ãƒ ã«ã‚ˆã‚‹è‡ªå‹•PR',
                '',
                '### æ¤œå‡ºã•ã‚ŒãŸå•é¡Œ',
                '',
                `- **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼**: \`${workflowFile}\``,
                `- **ã‚¨ãƒ©ãƒ¼**: ${{ github.event.inputs.error_description }}`,
                '',
                '### LLMã«ã‚ˆã‚‹åˆ†æã¨ä¿®æ­£',
                '',
                explanation,
                '',
                '### ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦³ç‚¹',
                '',
                '- [ ] ä¿®æ­£å†…å®¹ã¯æ­£ã—ã„ã‹',
                '- [ ] æ—¢å­˜ã®æ©Ÿèƒ½ã‚’å£Šã—ã¦ã„ãªã„ã‹',
                '- [ ] ä»–ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¸ã®å½±éŸ¿ã¯ãªã„ã‹',
                '',
                '### ãƒãƒ¼ã‚¸å¾Œã®ç¢ºèª',
                '',
                '- [ ] ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã‹',
                '- [ ] åŒã˜ã‚¨ãƒ©ãƒ¼ãŒå†ç™ºã—ãªã„ã‹',
                '',
                '---',
                '',
                'ğŸ¤– ã“ã®PRã¯è‡ªå·±ä¿®å¾©ã‚·ã‚¹ãƒ†ãƒ ã«ã‚ˆã£ã¦è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚',
                '**äººé–“ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨æ‰¿èªãŒå¿…è¦ã§ã™ã€‚**',
                '',
                `Triggered by: @${context.actor}`
              ].join('\n')
            });

            console.log(`âœ… Created PR #${pr.data.number}`);
            console.log(`URL: ${pr.data.html_url}`);

            // PRã«ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ 
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.data.number,
              labels: ['auto-healing', 'needs-review']
            });

      - name: Update Issue with PR link
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ steps.create-issue.outputs.issue_number }};

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: [
                '## âœ… ä¿®æ­£PRãŒä½œæˆã•ã‚Œã¾ã—ãŸ',
                '',
                'è‡ªå·±ä¿®å¾©ã‚·ã‚¹ãƒ†ãƒ ãŒLLMã‚’ä½¿ç”¨ã—ã¦ä¿®æ­£æ¡ˆã‚’ç”Ÿæˆã—ã€PRã‚’ä½œæˆã—ã¾ã—ãŸã€‚',
                '',
                '### æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—',
                '',
                '1. ä¸Šè¨˜ã®PRã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„',
                '2. ä¿®æ­£å†…å®¹ãŒæ­£ã—ã‘ã‚Œã°æ‰¿èªã—ã¦ãã ã•ã„',
                '3. ãƒãƒ¼ã‚¸ã—ã¦ãã ã•ã„',
                '',
                '---',
                '',
                `ğŸ¤– Triggered by: @${context.actor}`
              ].join('\n')
            });
