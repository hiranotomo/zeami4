# Event Model v1 - STREAM C: Self-Healing/Monitoring
# Purpose: Health check for self-healing system
# Triggers: schedule, workflow_dispatch
# Dependencies: None
# Last updated: 2025-11-23

name: üè• Ëá™Âãï‰øÆÂæ©„Ç∑„Çπ„ÉÜ„É† „Éò„É´„Çπ„ÉÅ„Çß„ÉÉ„ÇØ

on:
  schedule:
    - cron: '0 */6 * * *'  # 6ÊôÇÈñì„Åî„Å®
  workflow_dispatch:  # ÊâãÂãïÂÆüË°å„ÇÇÂèØËÉΩ

permissions:
  contents: read
  issues: write
  actions: read

jobs:
  health-check:
    name: Health Check
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Check if repository has recent activity
        id: activity
        uses: actions/github-script@v7
        with:
          script: |
            // ÈÅéÂéª24ÊôÇÈñì„ÅÆIssue/PR‰ΩúÊàê„Çí„ÉÅ„Çß„ÉÉ„ÇØ
            const since = new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString();

            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              since,
              state: 'all'
            });

            const hasActivity = issues.data.length > 0;
            console.log(`üìä Recent activity (past 24h): ${issues.data.length} issues/PRs`);
            console.log(`Has activity: ${hasActivity}`);
            core.setOutput('has_activity', hasActivity);

            return hasActivity;

      - name: Skip if no recent activity
        if: steps.activity.outputs.has_activity != 'true'
        run: |
          echo "‚è≠Ô∏è  No recent activity in the past 24 hours"
          echo "Skipping health check to save resources"
          exit 0

      - name: Check Claude Code Action health
        if: steps.activity.outputs.has_activity == 'true'
        id: claude_check
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT_FOR_HEALTH_CHECK }}
          script: |
            console.log('üè• Starting Claude Code Action health check...');

            // workflow-bug„É©„Éô„É´„ÅßËªΩÈáè„ÉÜ„Çπ„ÉàIssue„Çí‰ΩúÊàê
            const testIssue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üè• Health Check: Auto-Healing System Test',
              body: [
                '## üè• „Éò„É´„Çπ„ÉÅ„Çß„ÉÉ„ÇØ',
                '',
                '„Åì„Çå„ÅØËá™Âãï‰øÆÂæ©„Ç∑„Çπ„ÉÜ„É†„ÅÆ„Éò„É´„Çπ„ÉÅ„Çß„ÉÉ„ÇØÁî®„ÉÜ„Çπ„ÉàIssue„Åß„Åô„ÄÇ',
                '',
                '### ÊúüÂæÖ„Åï„Çå„ÇãÂãï‰Ωú',
                '- claude.yml„ÅåËµ∑Âãï',
                '- Claude Code Action„ÅåÂøúÁ≠î',
                '- „Åì„ÅÆIssue„Å´ÂàÜÊûê„Ç≥„É°„É≥„Éà„Åå‰ªò„Åè',
                '',
                '‚úÖ ÂøúÁ≠î„Åå„ÅÇ„Çå„Å∞„Éò„É´„Çπ„ÉÅ„Çß„ÉÉ„ÇØÊàêÂäü',
                '',
                '‚è±Ô∏è 60ÁßíÂæå„Å´Ëá™ÂãïÁ¢∫Ë™ç„Åó„Åæ„Åô',
                '',
                '---',
                'ü§ñ Automated health check - ' + new Date().toISOString()
              ].join('\n'),
              labels: ['workflow-bug', 'health-check']
            });

            console.log(`‚úÖ Created test issue #${testIssue.data.number}`);
            core.setOutput('test_issue', testIssue.data.number);

            // 60ÁßíÂæÖÊ©ü„Åó„Å¶ClaudeÂøúÁ≠î„ÇíÁ¢∫Ë™ç
            console.log('‚è±Ô∏è  Waiting 60 seconds for Claude response...');
            await new Promise(resolve => setTimeout(resolve, 60000));

            // „Ç≥„É°„É≥„Éà„Çí„ÉÅ„Çß„ÉÉ„ÇØ
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: testIssue.data.number
            });

            const claudeResponse = comments.data.some(c =>
              c.user.login === 'claude[bot]' ||
              c.user.login === 'claude'
            );

            if (claudeResponse) {
              console.log('‚úÖ Claude Code Action is HEALTHY');

              // „ÉÜ„Çπ„ÉàIssue„Çí„ÇØ„É≠„Éº„Ç∫
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: testIssue.data.number,
                state: 'closed'
              });

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: testIssue.data.number,
                body: '‚úÖ **Health check PASSED** - Claude Code Action is operational\n\nü§ñ Auto-closed by health check'
              });

              core.setOutput('status', 'healthy');
              return true;
            } else {
              console.log('‚ùå Claude Code Action did NOT respond');
              core.setOutput('status', 'unhealthy');
              return false;
            }

      - name: Create alert if unhealthy
        if: steps.claude_check.outputs.status == 'unhealthy'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT_FOR_HEALTH_CHECK }}
          script: |
            const testIssueNumber = ${{ steps.claude_check.outputs.test_issue }};

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üö® ALERT: Self-Healing System Health Check Failed',
              body: [
                '## üö® „Éò„É´„Çπ„ÉÅ„Çß„ÉÉ„ÇØÂ§±Êïó',
                '',
                'Claude Code Action„ÅåÂøúÁ≠î„Åó„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ',
                '',
                `„ÉÜ„Çπ„ÉàIssue: #${testIssueNumber}`,
                `ÂÆüË°åÊôÇÂàª: ${new Date().toISOString()}`,
                '',
                '### Á¢∫Ë™ç‰∫ãÈ†Ö',
                '- [ ] claude.yml„ÅÆË®≠ÂÆö„ÇíÁ¢∫Ë™ç',
                '- [ ] CLAUDE_CODE_OAUTH_TOKEN„ÅÆÊúâÂäπÊÄß„ÇíÁ¢∫Ë™ç',
                '- [ ] GitHub Actions„ÅÆ„É≠„Ç∞„ÇíÁ¢∫Ë™ç',
                '- [ ] Claude Code Action„ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÁ¢∫Ë™ç',
                '',
                '### Ë™øÊüªÊâãÈ†Ü',
                '1. claude.yml„ÅÆÊúÄËøë„ÅÆÂÆüË°å„É≠„Ç∞„ÇíÁ¢∫Ë™ç',
                '2. workflow-bug„É©„Éô„É´„ÅÆ„Éà„É™„Ç¨„Éº„ÅåÂãï‰Ωú„Åó„Å¶„ÅÑ„Çã„ÅãÁ¢∫Ë™ç',
                '3. ÂøÖË¶Å„Å´Âøú„Åò„Å¶ÊâãÂãï„Åß„ÉÜ„Çπ„ÉàÂÆüË°å',
                '',
                '---',
                'üö® Automated alert from health check',
                `Run: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`
              ].join('\n'),
              labels: ['bug', 'urgent', 'auto-healing']
            });

      - name: Check workflow-failure-detector health
        if: steps.activity.outputs.has_activity == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            console.log('üè• Checking workflow-failure-detector health...');

            // ÊúÄÁµÇÂÆüË°å„ÇíÁ¢∫Ë™ç
            const runs = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'workflow-failure-detector.yml',
              per_page: 1
            });

            if (runs.data.workflow_runs.length === 0) {
              console.log('‚ö†Ô∏è  workflow-failure-detector has never run');
              return;
            }

            const lastRun = runs.data.workflow_runs[0];
            const lastRunTime = new Date(lastRun.created_at);
            const hoursSinceLastRun = (Date.now() - lastRunTime.getTime()) / (1000 * 60 * 60);

            console.log(`Last run: ${hoursSinceLastRun.toFixed(1)} hours ago`);
            console.log(`Status: ${lastRun.conclusion}`);

            if (hoursSinceLastRun > 7) {
              console.log('‚ö†Ô∏è  workflow-failure-detector has not run in over 7 hours (expected: every 6 hours)');
            } else {
              console.log('‚úÖ workflow-failure-detector is healthy');
            }

      - name: Summary
        if: steps.activity.outputs.has_activity == 'true'
        run: |
          echo "üè• Health Check Summary"
          echo "======================"
          echo "Claude Code Action: ${{ steps.claude_check.outputs.status || 'not checked' }}"
          echo "Test Issue: #${{ steps.claude_check.outputs.test_issue || 'N/A' }}"
          echo ""
          echo "‚úÖ Health check complete"
