# Event Model v1 - STREAM A: PR-Lifecycle
# Purpose: Detect merge conflicts in PR
# Triggers: pull_request
# Dependencies: None
# Last updated: 2025-11-23

name: ğŸ” ãƒãƒ¼ã‚¸ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆæ¤œå‡º

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  detect-conflict:
    name: Detect Merge Conflicts
    runs-on: ubuntu-latest
    timeout-minutes: 10
    # Skip on push events (workflow only designed for pull_request context)
    if: github.event_name == 'pull_request'

    steps:
      - name: Check PR merge status
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            console.log(`PR #${context.issue.number} mergeable status: ${pr.mergeable}`);
            console.log(`Mergeable state: ${pr.mergeable_state}`);

            const hasConflict = pr.mergeable === false;
            core.setOutput('has_conflict', hasConflict);
            core.setOutput('mergeable_state', pr.mergeable_state);

            return hasConflict;

      - name: Add merge-conflict label
        if: steps.check.outputs.has_conflict == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            // Check if label already exists
            const labels = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const hasLabel = labels.data.some(label => label.name === 'merge-conflict');

            if (!hasLabel) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: ['merge-conflict']
              });

              console.log('Added merge-conflict label');
            } else {
              console.log('Label already exists');
            }

      - name: Comment on PR
        if: steps.check.outputs.has_conflict == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            // Check if we already commented
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const botComment = comments.data.find(comment =>
              comment.user.login === 'github-actions[bot]' &&
              comment.body.includes('ğŸ”´ ãƒãƒ¼ã‚¸ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆæ¤œå‡º')
            );

            if (botComment) {
              console.log('Conflict comment already exists, skipping');
              return;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ğŸ”´ ãƒãƒ¼ã‚¸ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆæ¤œå‡º

ã“ã®PRã¯ \`main\` ãƒ–ãƒ©ãƒ³ãƒã¨ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆã—ã¦ã„ã¾ã™ã€‚

### ğŸ”§ è‡ªå‹•è§£æ±ºã‚’è©¦è¡Œ

è‡ªå‹•ä¿®å¾©ã‚·ã‚¹ãƒ†ãƒ ãŒèµ·å‹•ã—ã€ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆè§£æ±ºã‚’è©¦ã¿ã¾ã™ã€‚

### ğŸ“‹ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

1. **è‡ªå‹•è§£æ±º**: Claude Code ActionãŒèµ·å‹•ã—ã¦ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆã‚’è§£æ±ºã—ã¾ã™
2. **ç¢ºèªå¾…ã¡**: è§£æ±ºå¾Œã€å¤‰æ›´å†…å®¹ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„
3. **æ‰‹å‹•è§£æ±º**: è¤‡é›‘ãªã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆã®å ´åˆã¯æ‰‹å‹•è§£æ±ºãŒå¿…è¦ã§ã™

### ğŸ¤– æ‰‹å‹•ã§è§£æ±ºã™ã‚‹å ´åˆ

\`\`\`bash
# ãƒ–ãƒ©ãƒ³ãƒã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
git checkout ${context.payload.pull_request.head.ref}

# mainãƒ–ãƒ©ãƒ³ãƒã‚’å–å¾—
git fetch origin main

# mainã‚’ãƒãƒ¼ã‚¸
git merge origin/main

# ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆã‚’è§£æ±ºå¾Œ
git add .
git commit -m "fix: Resolve merge conflict with main"
git push
\`\`\`

---
ğŸ¤– Auto-detected by Conflict Detector`
            });

      - name: Remove merge-conflict label if resolved
        if: steps.check.outputs.has_conflict == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                name: 'merge-conflict'
              });
              console.log('Removed merge-conflict label (conflict resolved)');
            } catch (error) {
              if (error.status === 404) {
                console.log('Label does not exist, nothing to remove');
              } else {
                throw error;
              }
            }

      - name: Summary
        run: |
          echo "ğŸ” Conflict Detection Summary"
          echo "=============================="
          echo "PR: #${{ github.event.pull_request.number }}"
          echo "Has conflict: ${{ steps.check.outputs.has_conflict }}"
          echo "Mergeable state: ${{ steps.check.outputs.mergeable_state }}"
          echo ""

          if [ "${{ steps.check.outputs.has_conflict }}" == "true" ]; then
            echo "âŒ Merge conflict detected - Auto-healing triggered"
          else
            echo "âœ… No merge conflicts"
          fi
