# Event Model v1 - STREAM B: Meta-Operations
# Purpose: Auto-add issues to project board
# Triggers: issues (opened)
# Dependencies: None
# Last updated: 2025-11-23

name: â„¹ï¸ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè‡ªå‹•è¿½åŠ 

on:
  issues:
    types: [opened]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  add-to-project:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Add Issue/PR to Project Board
        uses: actions/github-script@v7
        with:
          script: |
            const itemType = context.payload.issue ? 'Issue' : 'PR';
            const itemNumber = context.payload.issue?.number || context.payload.pull_request?.number;
            const itemTitle = context.payload.issue?.title || context.payload.pull_request?.title;

            console.log(`Adding ${itemType} #${itemNumber}: ${itemTitle} to project board`);

            // Note: GitHub Projects V2 APIã¯ç¾åœ¨actions/github-scriptã‹ã‚‰ç›´æŽ¥ä½¿ãˆãªã„ãŸã‚
            // ã“ã®å®Ÿè£…ã¯å°†æ¥ã®ãŸã‚ã«æº–å‚™ã—ã¦ã„ã¾ã™ã€‚
            // å®Ÿéš›ã®ä½¿ç”¨æ™‚ã¯ã€GitHub CLIã¾ãŸã¯GraphQL APIã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚

            console.log('âœ… Item logged for project tracking');
            console.log(`\nðŸ“Š Work Unit Information:`);

            // PRã®å ´åˆã€ãƒ–ãƒ©ãƒ³ãƒåã‹ã‚‰Work Unitæƒ…å ±ã‚’æŠ½å‡º
            if (context.payload.pull_request) {
              const branch = context.payload.pull_request.head.ref;
              const match = branch.match(/^(feature|hotfix|docs|test|fix)\/(\d+)-([\w-]+)-(\d+)$/);

              if (match) {
                const [, type, issueNum, workerType, timestamp] = match;
                const date = new Date(parseInt(timestamp) * 1000);

                console.log(`  Type: ${type}`);
                console.log(`  Issue: #${issueNum}`);
                console.log(`  Worker: ${workerType}`);
                console.log(`  Started: ${date.toISOString()}`);

                // PRã«Work Unitæƒ…å ±ã‚’ãƒ©ãƒ™ãƒ«ã§ä»˜ä¸Ž
                const labels = [];
                if (workerType === 'main') labels.push('work-unit: main');
                else if (workerType.startsWith('explore')) labels.push('work-unit: sub-explore');
                else if (workerType.startsWith('test')) labels.push('work-unit: sub-test');
                else if (workerType.startsWith('workflow')) labels.push('work-unit: sub-workflow');
                else if (workerType === 'runner') labels.push('work-unit: auto-runner');

                if (labels.length > 0) {
                  await github.rest.issues.addLabels({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: itemNumber,
                    labels: labels
                  });

                  console.log(`  Labels: ${labels.join(', ')}`);
                }
              }
            }
