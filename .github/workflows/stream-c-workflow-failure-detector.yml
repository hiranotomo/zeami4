# Event Model v1 - STREAM C: Self-Healing/Monitoring
# Purpose: Detect workflow failures
# Triggers: schedule (every 6h)
# Dependencies: None
# Last updated: 2025-11-23

name: ğŸš¨ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼éšœå®³æ¤œçŸ¥

on:
  schedule:
    - cron: '0 */6 * * *'  # 6æ™‚é–“ã”ã¨ã«å®šæœŸãƒã‚§ãƒƒã‚¯
  workflow_dispatch:

permissions:
  contents: read
  issues: write
  actions: read
  pull-requests: write

jobs:
  detect-failures:
    name: Detect Workflow Failures
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Fetch recent workflow failures
        id: detect
        uses: actions/github-script@v7
        with:
          script: |
            // éå»100ä»¶ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œã‚’åˆ†æ
            const runs = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });

            const failureStats = {};

            // å¤±æ•—ç‡ã‚’è¨ˆç®—
            for (const run of runs.data.workflow_runs) {
              const name = run.name;
              if (!failureStats[name]) {
                failureStats[name] = { total: 0, failed: 0, lastFailureId: null };
              }
              failureStats[name].total++;
              if (run.conclusion === 'failure') {
                failureStats[name].failed++;
                failureStats[name].lastFailureId = run.id;
              }
            }

            // é«˜é »åº¦å¤±æ•—ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’æ¤œå‡º
            const criticalFailures = [];
            for (const [name, stats] of Object.entries(failureStats)) {
              const failureRate = stats.failed / stats.total;
              if (failureRate >= 0.9 && stats.failed >= 5) {
                criticalFailures.push({ name, ...stats, failureRate });
              }
            }

            console.log(`\nğŸ“Š Workflow Failure Analysis:`);
            console.log(`Total workflows analyzed: ${Object.keys(failureStats).length}`);
            console.log(`Critical failures detected: ${criticalFailures.length}\n`);

            // å„å¤±æ•—ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®Issueã‚’ä½œæˆ
            for (const failure of criticalFailures) {
              console.log(`\nğŸ” Processing: ${failure.name}`);
              console.log(`   Failure rate: ${(failure.failureRate * 100).toFixed(1)}%`);
              console.log(`   Failed/Total: ${failure.failed}/${failure.total}`);

              // æ—¢å­˜ã®Issueã‚’ãƒã‚§ãƒƒã‚¯
              const existing = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: 'workflow-bug',
                state: 'open'
              });

              const alreadyReported = existing.data.some(issue =>
                issue.title.includes(failure.name)
              );

              if (alreadyReported) {
                console.log(`   â­ï¸  Issue already exists, skipping...`);
                continue;
              }

              // ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’å–å¾—
              const jobs = await github.rest.actions.listJobsForWorkflowRun({
                owner: context.repo.owner,
                repo: context.repo.repo,
                run_id: failure.lastFailureId
              });

              const failedJob = jobs.data.jobs.find(j => j.conclusion === 'failure');
              const errorLog = failedJob ? `Run: ${failure.lastFailureId}\nJob: ${failedJob.name}` : '';

              // False Positiveæ¤œå‡ºï¼šã‚¤ãƒ³ãƒ•ãƒ©ã‚¨ãƒ©ãƒ¼ã‹ã©ã†ã‹ãƒã‚§ãƒƒã‚¯
              const isInfrastructureError = (logText) => {
                const infraErrors = [
                  'Repository not found',
                  'API rate limit',
                  'timeout',
                  'network error',
                  'connection reset',
                  'ECONNRESET',
                  'ETIMEDOUT',
                  'Service Unavailable'
                ];
                return infraErrors.some(e => logText.toLowerCase().includes(e.toLowerCase()));
              };

              if (isInfrastructureError(errorLog)) {
                console.log(`   â­ï¸  Infrastructure error detected (false positive), skipping...`);
                continue;
              }

              // Issueã‚’ä½œæˆï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå½¢å¼ï¼‰
              const severityLabel = failure.failureRate === 1 ? 'Critical (100% failure rate)' :
                                   failure.failureRate > 0.8 ? 'High (>80% failure rate)' :
                                   failure.failureRate > 0.5 ? 'Medium (50-80% failure rate)' :
                                   'Low (<50% failure rate)';

              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ğŸ¤– Workflow Bug: ${failure.name} (${(failure.failureRate * 100).toFixed(0)}% failure rate)`,
                body: [
                  '## ğŸš¨ è‡ªå‹•æ¤œå‡º: ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ç•°å¸¸',
                  '',
                  'ã“ã®Issueã¯workflow-failure-detectorã«ã‚ˆã‚Šè‡ªå‹•ä½œæˆã•ã‚Œã¾ã—ãŸã€‚',
                  '',
                  '### è‡ªå‹•ä¿®å¾©ãƒ—ãƒ­ã‚»ã‚¹',
                  '',
                  '1. âœ… **è‡ªå‹•æ¤œå‡º**: workflow-failure-detectorãŒå¤±æ•—ã‚’æ¤œå‡º',
                  '2. âœ… **Issueä½œæˆ**: ã“ã®IssueãŒè‡ªå‹•ä½œæˆã•ã‚Œã‚‹',
                  '3. ğŸ”„ **è‡ªå‹•ä¿®å¾©**: Claude Code ActionãŒèµ·å‹•ã—ã¦ä¿®æ­£PRã‚’ä½œæˆ',
                  '4. â³ **ãƒ¬ãƒ“ãƒ¥ãƒ¼**: äººé–“ãŒPRã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ»ãƒãƒ¼ã‚¸',
                  '',
                  '---',
                  '',
                  '### ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å',
                  `\`${failure.name}\``,
                  '',
                  '### å¤±æ•—ç‡',
                  `${(failure.failureRate * 100).toFixed(1)}% (${failure.failed}/${failure.total})`,
                  '',
                  '### å¤±æ•—Run URL',
                  `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${failure.lastFailureId}`,
                  '',
                  '### ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°',
                  '```',
                  errorLog || 'No error log available',
                  '```',
                  '',
                  '### ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—ï¼ˆæ¨å®šï¼‰',
                  'Unknown',
                  '',
                  '### æ·±åˆ»åº¦',
                  severityLabel,
                  '',
                  '### è‡ªå‹•ä¿®å¾©ã‚ªãƒ—ã‚·ãƒ§ãƒ³',
                  '- [x] Claude Code Actionã§è‡ªå‹•ä¿®å¾©ã‚’è©¦è¡Œ',
                  '- [ ] False Positiveï¼ˆã‚¤ãƒ³ãƒ•ãƒ©ã‚¨ãƒ©ãƒ¼ï¼‰ã®å¯èƒ½æ€§ã‚’ãƒã‚§ãƒƒã‚¯',
                  '- [ ] äººé–“ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å¾…ã¤',
                  '',
                  '---',
                  '',
                  'ğŸ¤– Auto-created by Workflow Failure Detector'
                ].join('\n'),
                labels: ['workflow-bug', 'auto-healing', 'needs-review']
              });

              console.log(`   âœ… Created issue #${issue.data.number}: ${issue.data.title}`);
            }

            if (criticalFailures.length === 0) {
              console.log('\nâœ… No critical workflow failures detected!');
              console.log('::notice title=âœ… å¯¾å¿œä¸è¦: ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼éšœå®³æ¤œçŸ¥æˆåŠŸ::ç•°å¸¸ãªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ');
            } else {
              console.log(`::error title=ğŸ”´ å¯¾å¿œå¿…è¦: ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼éšœå®³æ¤œçŸ¥::${criticalFailures.length}ä»¶ã®ç•°å¸¸ãªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’æ¤œå‡ºã—ã¾ã—ãŸ`);
            }
