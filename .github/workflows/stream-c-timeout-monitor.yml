# Event Model v1 - STREAM C: Self-Healing/Monitoring
# Purpose: Monitor workflow timeouts
# Triggers: schedule, workflow_dispatch
# Dependencies: None
# Last updated: 2025-11-23

name: â±ï¸ Timeout Monitor

# Purpose: Detect and report workflow timeout violations
# Runs every 6 hours to check for workflows that exceeded timeout or timed out
# Creates Issues for timeout violations with detailed information

on:
  schedule:
    - cron: '0 */6 * * *'  # Run every 6 hours
  workflow_dispatch:  # Allow manual trigger for testing

# Minimum privilege principle: only the permissions we actually need
permissions:
  actions: read   # To list workflow runs
  issues: write   # To create issues for timeout violations
  contents: read  # Default read access

jobs:
  monitor-timeouts:
    name: Monitor Workflow Timeouts
    runs-on: ubuntu-latest

    steps:
      - name: Check for timeout violations
        uses: actions/github-script@v7
        with:
          script: |
            const HOURS_TO_CHECK = 24;
            const TIMEOUT_LABEL = 'workflow-timeout';

            // Calculate timestamp for 24 hours ago
            const twentyFourHoursAgo = new Date();
            twentyFourHoursAgo.setHours(twentyFourHoursAgo.getHours() - HOURS_TO_CHECK);
            const sinceTime = twentyFourHoursAgo.toISOString();

            console.log([
              'â±ï¸ Timeout Monitor Starting...',
              '',
              'Configuration:',
              `  Time window: Last ${HOURS_TO_CHECK} hours`,
              `  Since: ${sinceTime}`,
              ''
            ].join('\n'));

            // Fetch workflow runs from the last 24 hours
            // Using list API with per_page to get sufficient data
            const runs = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              created: `>=${sinceTime}`,
              per_page: 100
            });

            console.log(`Total runs found: ${runs.data.workflow_runs.length}`);

            // Filter for timeout violations
            // Check for:
            // 1. conclusion: "timed_out" - workflow hit GitHub's timeout
            // 2. conclusion: "cancelled" with timeout indicators
            const timeoutViolations = [];

            for (const run of runs.data.workflow_runs) {
              const isCancelled = run.conclusion === 'cancelled';
              const isTimedOut = run.conclusion === 'timed_out';

              if (isTimedOut || isCancelled) {
                console.log([
                  '',
                  `Checking: ${run.name}`,
                  `  Run ID: ${run.id}`,
                  `  Conclusion: ${run.conclusion}`,
                  `  Status: ${run.status}`
                ].join('\n'));

                // Get job details to check for timeout indicators
                const jobs = await github.rest.actions.listJobsForWorkflowRun({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  run_id: run.id
                });

                // Check if any job timed out
                const timedOutJob = jobs.data.jobs.find(job =>
                  job.conclusion === 'timed_out' ||
                  job.conclusion === 'cancelled'
                );

                if (timedOutJob) {
                  // Calculate duration in minutes
                  const startTime = new Date(run.created_at);
                  const endTime = new Date(run.updated_at);
                  const durationMs = endTime - startTime;
                  const durationMinutes = Math.floor(durationMs / 1000 / 60);

                  timeoutViolations.push({
                    workflowName: run.name,
                    runId: run.id,
                    runUrl: run.html_url,
                    conclusion: run.conclusion,
                    status: run.status,
                    durationMinutes: durationMinutes,
                    createdAt: run.created_at,
                    updatedAt: run.updated_at,
                    jobName: timedOutJob.name,
                    jobConclusion: timedOutJob.conclusion
                  });

                  console.log(`  âš ï¸ Timeout violation detected!`);
                  console.log(`  Duration: ${durationMinutes} minutes`);
                }
              }
            }

            console.log([
              '',
              '=' .repeat(60),
              `Total timeout violations found: ${timeoutViolations.length}`,
              '=' .repeat(60)
            ].join('\n'));

            // If no violations found, exit successfully
            if (timeoutViolations.length === 0) {
              console.log([
                '',
                'âœ… No timeout violations detected in the last 24 hours.',
                '::notice title=âœ… Timeout Monitor::No timeout violations detected'
              ].join('\n'));
              return;
            }

            // Group violations by workflow name for better reporting
            const violationsByWorkflow = {};
            for (const violation of timeoutViolations) {
              if (!violationsByWorkflow[violation.workflowName]) {
                violationsByWorkflow[violation.workflowName] = [];
              }
              violationsByWorkflow[violation.workflowName].push(violation);
            }

            // Check if we already have an open issue for timeout violations
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: TIMEOUT_LABEL,
              state: 'open'
            });

            // For each workflow with violations, create or update an issue
            for (const [workflowName, violations] of Object.entries(violationsByWorkflow)) {
              console.log([
                '',
                `Processing violations for: ${workflowName}`,
                `  Violations count: ${violations.length}`
              ].join('\n'));

              // Check if we already have an open issue for this workflow
              const existingIssue = existingIssues.data.find(issue =>
                issue.title.includes(workflowName)
              );

              if (existingIssue) {
                console.log(`  â­ï¸  Issue #${existingIssue.number} already exists, skipping...`);
                continue;
              }

              // Build violation details table
              const violationTable = [
                '| Run ID | Duration | Conclusion | Date | Link |',
                '|--------|----------|------------|------|------|'
              ];

              for (const v of violations) {
                violationTable.push([
                  `| ${v.runId}`,
                  `| ${v.durationMinutes} min`,
                  `| ${v.conclusion}`,
                  `| ${new Date(v.createdAt).toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' })}`,
                  `| [View Run](${v.runUrl}) |`
                ].join(' '));
              }

              // Calculate statistics
              const avgDuration = Math.floor(
                violations.reduce((sum, v) => sum + v.durationMinutes, 0) / violations.length
              );
              const maxDuration = Math.max(...violations.map(v => v.durationMinutes));

              // Create issue
              const issueBody = [
                '## â±ï¸ Workflow Timeout Violation Detected',
                '',
                'ã“ã®Issueã¯Timeout Monitorã«ã‚ˆã‚Šè‡ªå‹•ä½œæˆã•ã‚Œã¾ã—ãŸã€‚',
                '',
                '### ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å',
                `\`${workflowName}\``,
                '',
                '### æ¤œå‡ºæœŸé–“',
                `éå» ${HOURS_TO_CHECK} æ™‚é–“`,
                '',
                '### çµ±è¨ˆæƒ…å ±',
                `- æ¤œå‡ºã•ã‚ŒãŸé•åæ•°: ${violations.length}`,
                `- å¹³å‡å®Ÿè¡Œæ™‚é–“: ${avgDuration} åˆ†`,
                `- æœ€å¤§å®Ÿè¡Œæ™‚é–“: ${maxDuration} åˆ†`,
                '',
                '### ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè©³ç´°',
                '',
                violationTable.join('\n'),
                '',
                '### æ¨å¥¨å¯¾å¿œ',
                '',
                '1. **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®æœ€é©åŒ–ã‚’æ¤œè¨**',
                '   - ä¸è¦ãªã‚¹ãƒ†ãƒƒãƒ—ã®å‰Šé™¤',
                '   - ä¸¦åˆ—å®Ÿè¡Œã®æ´»ç”¨',
                '   - ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®æ´»ç”¨',
                '',
                '2. **ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šã®è¦‹ç›´ã—**',
                '   - `timeout-minutes` ã‚’é©åˆ‡ã«è¨­å®š',
                '   - ã‚¸ãƒ§ãƒ–ãƒ¬ãƒ™ãƒ«ãƒ»ã‚¹ãƒ†ãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ã§ã®è¨­å®š',
                '',
                '3. **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®åˆ†å‰²**',
                '   - å¤§ããªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’è¤‡æ•°ã®å°ã•ãªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã«åˆ†å‰²',
                '',
                '### é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ',
                '',
                '- [GitHub Actions - Timeoutè¨­å®š](https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#jobsjob_idtimeout-minutes)',
                '- [ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®æœ€é©åŒ–ã‚¬ã‚¤ãƒ‰](https://docs.github.com/en/actions/using-workflows/caching-dependencies-to-speed-up-workflows)',
                '',
                '---',
                '',
                'ğŸ¤– Auto-created by Timeout Monitor',
                `ğŸ“… Detected at: ${new Date().toISOString()}`
              ].join('\n');

              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `â±ï¸ Timeout Violation: ${workflowName} (${violations.length} violations in ${HOURS_TO_CHECK}h)`,
                body: issueBody,
                labels: [TIMEOUT_LABEL, 'workflow-optimization', 'needs-review']
              });

              console.log(`  âœ… Created issue #${issue.data.number}`);
              console.log(`  URL: ${issue.data.html_url}`);
            }

            // Set workflow annotation
            const totalViolations = timeoutViolations.length;
            const workflowCount = Object.keys(violationsByWorkflow).length;
            console.log([
              '',
              `::warning title=â±ï¸ Timeout Violations Detected::${totalViolations} timeout violations found in ${workflowCount} workflows`
            ].join('\n'));
