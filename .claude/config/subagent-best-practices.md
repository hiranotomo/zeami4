# サブエージェント活用ベストプラクティス

このドキュメントは、プロジェクト内で使用可能なサブエージェントの一覧、使用基準、および活用のベストプラクティスを定義します。

## サブエージェントタイプ一覧

### general-purpose (汎用エージェント)

**用途**: 複雑な調査、コード検索、マルチステップタスク

**特性**:
- 汎用のツールセット（Read, Write, Edit, Bash, Glob, Grep）を持つ
- コードベース全体を自由に検索・探索できる
- ファイル読み取りと編集に特化

**使用タイミング**:
- ファイル検索が複数回必要な場合
- codebase探索が必要な場合
- 複数のファイルを読み込んで分析が必要な場合
- パターンマッチングと検索が中心のタスク

**トークン考慮**:
- 広範な検索を許可できる
- 複数ファイルの読み込みに適している

**制限**:
- 並列実行のみ可能（時間制限あり）

---

### workflow-implementer (ワークフロー実装エージェント)

**用途**: GitHub Actionsワークフローの実装

**特性**:
- `.github/workflows/` 配下のワークフローファイル専門
- YAML構文、GitHub Actions特有の構文に精通
- ワークフロー実装のベストプラクティスに従う

**使用タイミング**:
- ワークフローファイルの新規作成が必要
- 既存ワークフローの修正が必要
- ワークフロー設定の最適化が必要

**実装責任範囲**:
- `.github/workflows/` 配下のYAMLファイル作成・修正
- YAML構文の正確性
- GitHub Actions特有の構文（`${{ }}`、secrets、contextsなど）の正しい使用
- ワークフロー実装のベストプラクティス遵守

**実装方針**:
1. **YAML構文の厳密性**
   - インデントはスペース2つ
   - 文字列のクォート処理を正確に
   - github-script での複数行文字列は `array.join('\n')` パターンを使用

2. **エラーハンドリング**
   - ワークフロー失敗時も適切なエラーメッセージ出力
   - `core.setFailed()` でエラーを明示

3. **テスタビリティ**
   - ワークフロー実行状況をログ出力
   - テストエージェントでテスト可能な形で実装

4. **ドキュメント**
   - ワークフローファイル内にコメントで説明記載
   - 複雑なロジックは特に詳しく

**非責任範囲**:
- ワークフローの実行（テストエージェントが担当）
- Branch Protection など GitHub設定の変更

---

### test-implementer (テスト実装エージェント)

**用途**: テストコード（ワークフローテスト、ユニットテストなど）の実装

**特性**:
- `tests/` 配下のテストコード専門
- ワークフローテスト、ユニットテスト、E2Eテストに対応
- テスト駆動開発の原則を実践

**使用タイミング**:
- ユニットテストの作成・修正
- ワークフローテストの作成
- E2Eテストの作成
- テストコードの充実化

**責任範囲**:
- `tests/` 配下のテストコード作成・修正
- ワークフローテスト（`tests/workflows/*.test.js`）
- ユニットテスト（`src/**/*.spec.ts`）
- E2Eテスト（`tests/e2e/`）

**実装方針**:
1. **テストの独立性**
   - 各テストケースは独立して実行可能
   - テスト間の依存を避ける
   - クリーンアップを確実に実行

2. **テストケースの網羅性**
   - 正常系・異常系を両方カバー
   - エッジケースも考慮
   - 仕様書のすべてのケースをテスト

3. **可読性**
   - テスト名は「何をテストしているか」が明確
   - Arrange-Act-Assert パターンを使用
   - コメントで期待値を明記

4. **メンテナンス性**
   - テストヘルパー関数を活用（runner.js など）
   - 重複コードを避ける
   - テストデータは定数化

**テストインフラ活用例**:
```javascript
runner.addTest('test name', async (runner) => {
  const issue = await runner.createTestIssue('title', 'body');
  await runner.sleep(10000);
  const updated = await runner.getIssue(issue.number);
  if (!updated.milestone) {
    throw new Error('Expected milestone to be set');
  }
});
```

**非責任範囲**:
- テストの実行（CI）
- ワークフローの実装

---

### wiki-migration-agent (Wiki移行エージェント)

**用途**: ドキュメントのWiki移行自動化

**特性**:
- ローカル `docs/` から GitHub Wiki への移行
- 差分ベースの処理によるトークン最適化
- 自動化とベストプラクティス遵守

**使用タイミング**:
- PRクローズ時（`docs/**/*.md` に変更があるPR）
- 手動実行時（`/wiki-migrate` コマンド）
- Wiki常時更新化が必要なとき

**責任範囲**:
- ドキュメント変更の自動検出
- Wiki への差分ベース更新
- ローカルファイルの削除管理
- エラーハンドリングと警告

**実装方針**:
1. **差分ベース処理**
   - 全ファイルスキャンではなく、変更されたファイルのみ処理
   - Wiki既存ページとの差分チェック

2. **トークン節約**
   - キャッシュ利用（Wiki既存ページリスト）
   - 条件付きスキップ（内容が同一なら更新不要）

3. **自動化**
   - PRマージ時の自動トリガー
   - 手動実行オプション

4. **許可リスト管理**
   - ローカル保持OK: `README.md`, `CONTRIBUTING.md`, `CHANGELOG.md`, `LICENSE.md`
   - それ以外の `docs/*.md` は Wiki移行対象

**非責任範囲**:
- GitHub 設定変更（Wiki有効化など）

---

### wiki-update-agent (Wiki更新エージェント)

**用途**: 既存Wikiページの内容更新・最適化

**特性**:
- Wiki ページの内容管理に特化
- 既存ドキュメントの更新・保守
- コンテンツの質向上

**使用タイミング**:
- Wiki ページの内容更新が必要
- ドキュメント品質の向上
- 記述の一貫性を保つ

**責任範囲**:
- Wiki ページの内容更新
- 表現・表記の最適化
- 構造の改善

---

### issue-test-agent (Issue テストエージェント)

**用途**: Issue処理フロー、ラベル管理のテスト

**特性**:
- Issue 関連のテスト専門
- ワークフローテストの補助

**使用タイミング**:
- Issue 処理フロー検証が必要
- ラベル管理の動作確認

---

### test-infrastructure (テストインフラ)

**用途**: テスト実行基盤の構築・拡張

**特性**:
- `runner.js` などのテストユーティリティ管理
- テスト環境の整備

**使用タイミング**:
- テスト実行基盤の拡張
- テストヘルパー関数の追加

---

## 使用基準

### サブエージェントを使うべき場合

✅ **複数ファイルの調査が必要**
- コードベース全体から検索が必要
- 複数ファイルを読み込んで分析が必要
- パターンマッチングが必要

✅ **複数ステップのタスク**
- 複雑な実装作業
- 複数フェーズの処理
- 前後の依存関係がある処理

✅ **並列実行可能なタスク**
- 独立した複数タスク（例：テスト + ドキュメント作成）
- 時間効率を重視する場合

✅ **専門性が高いタスク**
- ワークフロー実装（workflow-implementer）
- テストコード作成（test-implementer）
- Wiki管理（wiki-migration-agent）

✅ **トークン効率が重要**
- 差分ベース処理が可能
- キャッシュ活用が可能
- 段階的な処理が可能

### サブエージェントを使わない場合

❌ **単一ファイルの読み取り**
- 1ファイルの確認だけ
- 簡単な内容確認

❌ **簡単な編集（1-2ファイル）**
- ファイル1-2つの軽微な修正
- メインエージェントで十分

❌ **即座に答えられる質問**
- 設定値の確認
- 簡単な情報提供
- 説明・ドキュメント参照

---

## サブエージェントタイプの選択ガイド

### タスク内容別の選択

| タスク内容 | 推奨エージェント | 理由 |
|-----------|-----------------|------|
| ワークフロー実装 | workflow-implementer | YAML構文、GitHub Actions専門知識 |
| テストコード作成 | test-implementer | テスト設計、テストランナー利用 |
| コード検索・分析 | general-purpose | 汎用的な検索・読み取り機能 |
| ドキュメント移行 | wiki-migration-agent | 自動化、差分ベース処理最適化 |
| Wiki更新・保守 | wiki-update-agent | コンテンツ管理専門 |
| 複合型タスク | 複数エージェント並列 | 独立したタスクは並列実行 |

### 複合型タスク例

**例：新機能実装 + テスト**
```
parallel:
  - agent: workflow-implementer
    task: GitHubワークフロー実装

  - agent: test-implementer
    task: テストコード作成
```

**メリット**:
- 実装とテストを並列実行
- トークン全体効率が向上
- 時間効率向上

---

## 並列実行のベストプラクティス

### 1. 並列実行可能な条件

✅ **タスク間に依存関係がない**
```
可能:
- ドキュメント調査 + コード実装
- テスト作成 + ドキュメント作成

不可:
- 実装完了後にテスト作成（依存関係あり）
- ファイル読み取り → 編集（順序重要）
```

✅ **エージェントの責任範囲が異なる**
```
可能:
- workflow-implementer (ワークフロー)
- test-implementer (テスト)

不可:
- 同じファイルを2つのエージェントで編集
```

### 2. 並列実行の実装方法

**単一メッセージで複数エージェント呼び出し**:
```bash
# メインエージェントから複数タスクを並列実行
複数Task toolを同時に呼び出す
→ 各エージェント独立で実行開始
→ すべての結果待機
```

### 3. 並列実行時の注意点

⚠️ **シード値・キー情報の共有**
```javascript
// 良い例：テスト用Issue作成をメインが行い、IDを渡す
const testIssueId = await mainAgent.createIssue(...);
// テストエージェントへはIDのみ渡す
await testAgent.runTest(testIssueId);

// 悪い例：各エージェントが独立してIssue作成
// → 複数Issue生成、クリーンアップ困難
```

⚠️ **ファイルシステム競合回避**
```
同じファイルを複数エージェントで編集しない
→ 責任範囲を明確に分離
```

⚠️ **ログ・出力の統合**
```
各エージェントの出力をメインが集約
→ 全体の進捗把握が容易
```

### 4. 依存関係がある場合（順次実行）

```
Step 1: workflow-implementer で実装
        ↓
Step 2: test-implementer でテスト作成
        ↓
Step 3: メインが確認・統合
```

---

## トークン最適化のヒント

### 1. エージェント選択時の最適化

**適切なエージェント選択 = トークン削減**
```
❌ 非効率: general-purpose で ワークフロー実装
  → 無駄な説明、確認が増える

✅ 効率: workflow-implementer で ワークフロー実装
  → 直接実装、余計な判断なし
```

### 2. ツール制限による最適化

```javascript
// 必要最小限のツール許可
{
  "tools": ["Read", "Write", "Edit"],  // 必要なもののみ
  // ❌ "tools": ["Read", "Write", "Edit", "Bash", "Grep", "Glob"]
}
```

**効果**:
- エージェントの判断肢が減少
- トークン消費削減
- 実行時間短縮

### 3. モデルパラメータの最適化

```javascript
// 簡単なタスク: Haiku を指定
{
  "model": "claude-haiku-4-5-20251001"
}

// 複雑なタスク: Sonnet を指定
{
  "model": "claude-sonnet-4-5-20250929"
}
```

**効果**:
- 不必要な高性能モデル選択を回避
- トークン全体効率向上

### 4. プロンプト最適化

**原則**:
- 簡潔さ優先（冗長な説明は避ける）
- 必要な背景情報のみ
- 既存ドキュメント参照（プロンプト埋め込みではなく）

```
❌ 冗長なプロンプト:
"あなたは...[10行の説明]...
このシステムでは...[詳細説明]...
実装すべきことは..."

✅ 簡潔なプロンプト:
"GitHub Actionsワークフロー実装エージェント
実装: [具体的タスク]
参照: docs/workflow-guide.md"
```

### 5. 差分ベース処理による最適化

**全体スキャン vs 差分処理**:
```bash
❌ 非効率：すべてのファイルを read（トークン大量消費）
✅ 効率：変更されたファイルのみ処理（トークン削減）

# Wiki更新の例：
全ファイルを読まず、PR の変更ファイルのみ取得
gh pr view <PR> --json files --jq '.files[].path'
```

### 6. キャッシュ・キープライブ活用

```bash
# Wiki ページリスト取得（1回のみ）
gh api repos/<user>/<repo>/wiki --jq '.[].title' > /tmp/wiki-pages.txt

# 以降はファイル参照（API 呼び出し不要）
grep -q "ページ名" /tmp/wiki-pages.txt
```

### 7. 条件付きスキップ

```bash
# 内容が同一なら処理スキップ
if diff docs/FILE.md existing/FILE.md > /dev/null; then
  echo "No changes, skipping"
  exit 0
fi
```

### 8. エージェント間の情報共有最適化

```javascript
// メインエージェントが1回だけ情報取得
const projectInfo = await readProjectStructure();

// 複数エージェントへは必要な情報のみ渡す
await agent1.run({ projectInfo });
await agent2.run({ projectInfo });

// ❌ 各エージェントが独立して projectInfo を取得
// → 重複アクセス、トークン浪費
```

---

## 実装ワークフロー

### フェーズ 1: 計画と分析（メインエージェント）

```
1. タスク要件の整理
2. 必要なエージェント特定
3. 依存関係・並列可能性の分析
4. トークン予算の確保
```

### フェーズ 2: エージェント選択と構成

```
1. 各タスクに最適なエージェント選択
2. ツール・モデルの最適化設定
3. 必要な背景情報の準備
```

### フェーズ 3: 実行

```
並列実行可能:
- 複数エージェントを同時に呼び出し
- 結果を集約

順次実行必要:
- Step 1 完了後 → Step 2 開始
```

### フェーズ 4: 統合と検証

```
1. 各エージェント出力の確認
2. 統合（不要なら省略）
3. 最終検証
4. コミット・デプロイ
```

---

## チェックリスト

### タスク開始時

- [ ] タスク要件を明確にしたか
- [ ] 適切なエージェント選択（複数）か
- [ ] 並列実行可能か、それとも順次か
- [ ] 必要なツール・モデルを指定したか
- [ ] トークン予算を確認したか
- [ ] 背景情報を準備したか

### エージェント実行時

- [ ] エージェント選択は適切か（責任範囲内か）
- [ ] プロンプトは簡潔か
- [ ] ツール制限は適切か
- [ ] ログ出力は充分か

### 結果統合時

- [ ] すべてのエージェント出力を確認したか
- [ ] 品質チェック完了したか
- [ ] テスト実行したか（必要なら）
- [ ] ドキュメント更新したか（必要なら）
- [ ] コミットメッセージは適切か

---

## 参考資料

### エージェント詳細定義

- `.claude/agents/workflow-implementer.md` - ワークフロー実装詳細
- `.claude/agents/test-implementer.md` - テスト実装詳細
- `.claude/agents/wiki-migration-agent.md` - Wiki移行詳細
- `.claude/agents/wiki-update-agent.md` - Wiki更新詳細
- `.claude/agents/test-infrastructure.md` - テストインフラ詳細

### 関連Issue

- Issue #426 - サブエージェント活用の中央集約化とベストプラクティス注入機構
- Issue #351 - Wiki移行完了
- Issue #421 - Wiki移行ルール徹底の仕組み化

---

**最終更新**: 2025-11-23
**バージョン**: 1.0
